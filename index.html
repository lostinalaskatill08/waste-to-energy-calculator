<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>US Integrated Energy & Water Transition Calculator</title>
  <style>
    :root {
      /* Light Mode Colors */
      --bg-color: #f5f5f5;
      --text-color: #333;
      --card-bg: #ffffff;
      --secondary-bg: #e5e7eb;
      --border-color: rgba(0,0,0,0.1);
      /* Dark Mode Colors */
      --dark-bg-color: #1f2937;
      --dark-text-color: #e5e7eb;
      --dark-card-bg: #374151;
      --dark-border-color: #4b5563;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.5;
      margin: 0;
      padding: 20px;
      color: var(--text-color);
      background-color: var(--bg-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark-mode {
      background-color: var(--dark-bg-color);
      color: var(--dark-text-color);
    }
    /* Remaining CSS unchanged */
    h1, h2, h3, h4 { margin-top: 0; }
    .container { max-width: 1200px; margin: 0 auto; }
    .card {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px var(--border-color);
      padding: 20px;
      margin-bottom: 20px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    body.dark-mode .card {
      background-color: var(--dark-card-bg);
      box-shadow: 0 2px 4px var(--dark-border-color);
    }
    .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 15px; }
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    @media (min-width: 768px) {
      .stats-grid { grid-template-columns: repeat(4, 1fr); }
      .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
    }
    .stat-box { padding: 15px; border-radius: 6px; border: 1px solid #e5e7eb; }
    body.dark-mode .stat-box { border-color: var(--dark-border-color); }
    .stat-box.blue { background-color: #eff6ff; }
    .stat-box.green { background-color: #ecfdf5; }
    .stat-box.yellow { background-color: #fffbeb; }
    .stat-box.purple { background-color: #f5f3ff; }
    body.dark-mode .stat-box.blue,
    body.dark-mode .stat-box.green,
    body.dark-mode .stat-box.yellow,
    body.dark-mode .stat-box.purple {
      background-color: #495057; color: #e5e7eb;
    }
    .stat-label { font-size: 0.875rem; color: #6b7280; margin-bottom: 5px; }
    body.dark-mode .stat-label { color: #d1d5db; }
    .stat-value { font-size: 1.25rem; font-weight: 600; }
    .stat-subtitle { font-size: 0.75rem; color: #6b7280; margin-top: 5px; }
    body.dark-mode .stat-subtitle { color: #d1d5db; }
    .grid { display: grid; gap: 20px; }
    .tabs { margin-bottom: 20px; }
    .tab-list {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      overflow-x: auto;
    }
    body.dark-mode .tab-list { border-color: var(--dark-border-color); }
    .tab-button {
      padding: 10px 15px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.875rem;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      transition: background-color 0.3s ease;
    }
    body.dark-mode .tab-button { color: #cbd5e1; }
    .tab-button.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      font-weight: 500;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .slider-container { margin-bottom: 15px; }
    .slider-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 5px;
    }
    .slider-values {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      margin-top: 5px;
    }
    .slider-current { font-weight: 500; font-size: 0.875rem; }
    input[type="range"] { width: 100%; }
    .flex { display: flex; align-items: center; }
    .toggle-container { display: flex; align-items: center; margin-bottom: 15px; }
    .toggle-label { font-size: 0.875rem; font-weight: 500; margin-right: 10px; }
    .toggle-button {
      border: 1px solid #d1d5db;
      background-color: #f9fafb;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.875rem;
      border-radius: 4px;
    }
    body.dark-mode .toggle-button {
      background-color: #4b5563;
      border-color: #6b7280;
      color: #e5e7eb;
    }
    .toggle-button.active {
      background-color: #2563eb;
      color: white;
      border-color: #2563eb;
    }
    body.dark-mode .toggle-button.active {
      background-color: #1d4ed8;
      border-color: #1d4ed8;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #e5e7eb; }
    body.dark-mode th, body.dark-mode td { border-color: var(--dark-border-color); }
    th { font-weight: 500; color: #4b5563; }
    body.dark-mode th { color: #cbd5e1; }
    .text-right { text-align: right; }
    .bar-chart { margin-top: 15px; }
    .bar {
      height: 25px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .bar-label { width: 120px; font-size: 0.75rem; padding-left: 8px; z-index: 1; }
    .bar-value { font-size: 0.75rem; margin-left: auto; padding-right: 8px; z-index: 1; }
    .bar-fill {
      position: absolute;
      height: 25px;
      background-color: #3b82f6;
      transition: width 0.3s ease;
      border-radius: 4px;
    }
    .center-text { text-align: center; }
    .metric-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      border-bottom: 1px solid #f3f4f6;
      padding-bottom: 8px;
    }
    body.dark-mode .metric-row { border-color: #4b5563; }
    .metric-label { font-size: 0.875rem; }
    .metric-value { font-size: 0.875rem; font-weight: 500; }
    .action-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background-color: #2563eb;
      color: white;
      cursor: pointer;
      font-size: 0.875rem;
      transition: background-color 0.2s ease;
    }
    button:hover { background-color: #1d4ed8; }
    button.secondary { background-color: #e5e7eb; color: #374151; }
    body.dark-mode button.secondary { background-color: #4b5563; color: #e5e7eb; }
    button.secondary:hover { background-color: #d1d5db; }
    body.dark-mode button.secondary:hover { background-color: #6b7280; }
    .dark-mode-toggle { margin-right: 1rem; }
  </style>
</head>
<body>
<div class="container">
  <div style="display:flex; justify-content: space-between; align-items:center;">
    <h1>US Integrated Energy & Water Transition Calculator</h1>
    <button class="dark-mode-toggle secondary" id="dark-mode-toggle">Toggle Dark Mode</button>
  </div>
  <p>Explore the combined impact of energy efficiency, renewable generation, transportation improvements, and water production systems.</p>

  <div class="tabs">
    <div class="tab-list">
      <button class="tab-button active" data-tab="summary">Summary</button>
      <button class="tab-button" data-tab="parameters">Input Parameters</button>
      <button class="tab-button" data-tab="efficiency">Energy Efficiency</button>
      <button class="tab-button" data-tab="renewable">Renewable Energy</button>
      <button class="tab-button" data-tab="transport">Transportation</button>
      <button class="tab-button" data-tab="water">Water Systems</button>
      <button class="tab-button" data-tab="phased">Phased Implementation</button>
    </div>
    
    <!-- SUMMARY TAB -->
    <div class="tab-content active" id="summary">
      <div class="grid grid-cols-2">
        <div class="card">
          <h3 class="card-title">Strategy Approach</h3>
          <div class="toggle-container">
            <span class="toggle-label">Generation First</span>
            <input type="range" min="0" max="1" step="1" value="1" id="efficiency-first-toggle" style="max-width: 60px; margin: 0 10px;">
            <span class="toggle-label">Efficiency First</span>
          </div>
          <div class="slider-container">
            <label class="slider-label">Implementation Speed</label>
            <input type="range" min="1" max="20" value="10" id="implementation-speed">
            <div class="slider-values">
              <span>Slower</span>
              <span class="slider-current" id="implementation-speed-value">10</span>
              <span>Faster</span>
            </div>
          </div>
          <div id="strategy-comparison">
            <table>
              <thead>
              <tr>
                <th>Strategy</th>
                <th>Investment</th>
                <th>Carbon Reduction</th>
                <th>Payback</th>
                <th>Jobs</th>
              </tr>
              </thead>
              <tbody>
              <tr>
                <td>Efficiency First</td>
                <td id="eff-first-investment">$1.89T</td>
                <td id="eff-first-carbon">920M tons</td>
                <td id="eff-first-payback">10.3 years</td>
                <td id="eff-first-jobs">3.3M</td>
              </tr>
              <tr>
                <td>Generation First</td>
                <td id="gen-first-investment">$2.65T</td>
                <td id="gen-first-carbon">644M tons</td>
                <td id="gen-first-payback">18.5 years</td>
                <td id="gen-first-jobs">1.5M</td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title">Key Results</h3>
          <div class="stats-grid">
            <div class="stat-box blue">
              <div class="stat-label">Net Energy Impact</div>
              <div class="stat-value" id="net-energy-impact">-707 TWh</div>
              <div class="stat-subtitle" id="net-energy-percent">-18.6% of US consumption</div>
            </div>
            <div class="stat-box green">
              <div class="stat-label">Carbon Reduction</div>
              <div class="stat-value" id="carbon-reduction">920 MT</div>
              <div class="stat-subtitle" id="carbon-percent">17.6% of US emissions</div>
            </div>
            <div class="stat-box yellow">
              <div class="stat-label">Total Investment</div>
              <div class="stat-value" id="total-investment">$1.89T</div>
              <div class="stat-subtitle" id="payback-period">Payback: 10.3 years</div>
            </div>
            <div class="stat-box purple">
              <div class="stat-label">Jobs Created</div>
              <div class="stat-value" id="jobs-created">3.3M</div>
              <div class="stat-subtitle" id="jobs-per-million">1.8 jobs per $1M</div>
            </div>
          </div>
          <h4 style="margin-top: 20px;">Carbon Reduction by Component</h4>
          <div id="carbon-breakdown" class="bar-chart"></div>
        </div>
      </div>
      <div class="grid grid-cols-2">
        <div class="card">
          <h3 class="card-title">Efficiency Impact</h3>
          <div id="efficiency-metrics"></div>
        </div>
        <div class="card">
          <h3 class="card-title">Renewable Energy</h3>
          <div id="renewable-metrics"></div>
        </div>
        <div class="card">
          <h3 class="card-title">Water Production</h3>
          <div id="water-metrics"></div>
        </div>
      </div>
      <!-- Enhancement: Added Last Calculated Timestamp -->
      <p id="last-updated" style="text-align: right; font-size: 0.8em; color: #666;">Last calculated: N/A</p>
    </div>
    
    <!-- PARAMETERS TAB (Unchanged) -->
    <div class="tab-content" id="parameters">
      <div class="grid grid-cols-2">
        <div class="card">
          <h3 class="card-title">Energy Efficiency Parameters</h3>
          <div class="slider-container">
            <label class="slider-label">Passive Solar Design Efficiency (%)</label>
            <input type="range" min="20" max="90" value="50" id="passive-solar-efficiency">
            <div class="slider-values">
              <span>20%</span>
              <span class="slider-current" id="passive-solar-efficiency-value">50%</span>
              <span>90%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Geothermal Heat Pump COP</label>
            <input type="range" min="2.5" max="5.0" step="0.1" value="3.5" id="gshp-cop">
            <div class="slider-values">
              <span>2.5</span>
              <span class="slider-current" id="gshp-cop-value">3.5</span>
              <span>5.0</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Heat Pump Water Heater Efficiency</label>
            <input type="range" min="2.0" max="3.5" step="0.1" value="2.5" id="hpwh-efficiency">
            <div class="slider-values">
              <span>2.0x</span>
              <span class="slider-current" id="hpwh-efficiency-value">2.5x</span>
              <span>3.5x</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">National Adoption Rate (%)</label>
            <input type="range" min="5" max="50" value="25" id="efficiency-adoption-rate">
            <div class="slider-values">
              <span>5%</span>
              <span class="slider-current" id="efficiency-adoption-rate-value">25%</span>
              <span>50%</span>
            </div>
          </div>
          <div class="toggle-container">
            <span class="toggle-label">Implementation Type:</span>
            <button class="toggle-button active" id="retrofit-button">Retrofit</button>
            <button class="toggle-button" id="new-construction-button">New Construction</button>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title">Renewable Energy Parameters</h3>
          <div class="slider-container">
            <label class="slider-label">Food Waste Utilization (%)</label>
            <input type="range" min="0" max="90" value="60" id="food-waste-utilization">
            <div class="slider-values">
              <span>0%</span>
              <span class="slider-current" id="food-waste-utilization-value">60%</span>
              <span>90%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Agricultural Waste Utilization (%)</label>
            <input type="range" min="0" max="80" value="40" id="agriculture-utilization">
            <div class="slider-values">
              <span>0%</span>
              <span class="slider-current" id="agriculture-utilization-value">40%</span>
              <span>80%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Forest Waste Utilization (%)</label>
            <input type="range" min="0" max="100" value="30" id="forest-utilization">
            <div class="slider-values">
              <span>0%</span>
              <span class="slider-current" id="forest-utilization-value">30%</span>
              <span>100%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Municipal Solid Waste Utilization (%)</label>
            <input type="range" min="0" max="100" value="50" id="msw-utilization">
            <div class="slider-values">
              <span>0%</span>
              <span class="slider-current" id="msw-utilization-value">50%</span>
              <span>100%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">SkySails Units Deployed</label>
            <input type="range" min="0" max="100000" step="5000" value="50000" id="skysails-units">
            <div class="slider-values">
              <span>0</span>
              <span class="slider-current" id="skysails-units-value">50,000</span>
              <span>100,000</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Electricity Price (¢/kWh)</label>
            <input type="range" min="5" max="25" value="10" id="electricity-price">
            <div class="slider-values">
              <span>5¢</span>
              <span class="slider-current" id="electricity-price-value">10¢</span>
              <span>25¢</span>
            </div>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title">Transportation Parameters</h3>
          <div class="slider-container">
            <label class="slider-label">Vehicle Fleet Retrofit (%)</label>
            <input type="range" min="0" max="100" value="50" id="retrofit-percentage">
            <div class="slider-values">
              <span>0%</span>
              <span class="slider-current" id="retrofit-percentage-value">50%</span>
              <span>100%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Carbon Capture Efficiency (%)</label>
            <input type="range" min="0" max="100" value="90" id="ccu-adoption">
            <div class="slider-values">
              <span>0%</span>
              <span class="slider-current" id="ccu-adoption-value">90%</span>
              <span>100%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Hemp Utilization (%)</label>
            <input type="range" min="0" max="100" value="50" id="hemp-utilization">
            <div class="slider-values">
              <span>0%</span>
              <span class="slider-current" id="hemp-utilization-value">50%</span>
              <span>100%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Algae Feedstock Adoption (%)</label>
            <input type="range" min="0" max="100" value="25" id="algae-percentage">
            <div class="slider-values">
              <span>0%</span>
              <span class="slider-current" id="algae-percentage-value">25%</span>
              <span>100%</span>
            </div>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title">Water Technology Parameters</h3>
          <div class="slider-container">
            <label class="slider-label">Energy Allocation to Water (%)</label>
            <input type="range" min="1" max="20" value="5" id="energy-allocation-to-water">
            <div class="slider-values">
              <span>1%</span>
              <span class="slider-current" id="energy-allocation-to-water-value">5%</span>
              <span>20%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Desalination Allocation (%)</label>
            <input type="range" min="0" max="100" value="60" id="desalination-allocation">
            <div class="slider-values">
              <span>0% (All AWG)</span>
              <span class="slider-current" id="desalination-allocation-value">60%</span>
              <span>100% (All Desalination)</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Water Technologies Efficiency (%)</label>
            <input type="range" min="50" max="150" value="100" id="water-techs-efficiency">
            <div class="slider-values">
              <span>50%</span>
              <span class="slider-current" id="water-techs-efficiency-value">100%</span>
              <span>150%</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Water Value ($/m³)</label>
            <input type="range" min="0.5" max="5" step="0.1" value="1.5" id="water-value-usd">
            <div class="slider-values">
              <span>$0.50</span>
              <span class="slider-current" id="water-value-usd-value">$1.50</span>
              <span>$5.00</span>
            </div>
          </div>
        </div>
        <div class="card">
          <h3 class="card-title">Solar & Nuclear Energy Parameters</h3>
          <div class="slider-container">
            <label class="slider-label">Solar Capacity (GW)</label>
            <input type="range" min="0" max="1000" step="10" value="200" id="solar-capacity">
            <div class="slider-values">
              <span>0 GW</span>
              <span class="slider-current" id="solar-capacity-value">200 GW</span>
              <span>1000 GW</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Solar Average Cost ($/kW)</label>
            <input type="range" min="300" max="2000" step="50" value="1000" id="solar-cost">
            <div class="slider-values">
              <span>$300/kW</span>
              <span class="slider-current" id="solar-cost-value">$1000/kW</span>
              <span>$2000/kW</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Nuclear Capacity (GW)</label>
            <input type="range" min="0" max="300" step="5" value="50" id="nuclear-capacity">
            <div class="slider-values">
              <span>0 GW</span>
              <span class="slider-current" id="nuclear-capacity-value">50 GW</span>
              <span>300 GW</span>
            </div>
          </div>
          <div class="slider-container">
            <label class="slider-label">Nuclear Average Cost ($/kW)</label>
            <input type="range" min="2000" max="8000" step="100" value="5000" id="nuclear-cost">
            <div class="slider-values">
              <span>$2000/kW</span>
              <span class="slider-current" id="nuclear-cost-value">$5000/kW</span>
              <span>$8000/kW</span>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top: 20px;">
        <button id="apply-parameters-button">Apply Changes</button>
      </div>
    </div>
    
    <!-- EFFICIENCY TAB -->
    <div class="tab-content" id="efficiency">
      <div class="card">
        <h3 class="card-title">Household Energy Savings</h3>
        <div class="grid grid-cols-2">
          <div>
            <table>
              <tr><th>Source</th><th>Energy Saved (kWh)</th></tr>
              <tr><td>Passive Solar</td><td id="passive-solar-savings">2,250</td></tr>
              <tr><td>GSHP Heating</td><td id="gshp-heating-savings">1,607</td></tr>
              <tr><td>GSHP Cooling</td><td id="gshp-cooling-savings">459</td></tr>
              <tr><td>HP Water Heater</td><td id="hpwh-savings">1,157</td></tr>
              <tr><td>HP Dryer</td><td id="dry-savings">150</td></tr>
              <tr><td><strong>Total Savings</strong></td><td id="total-household-savings"><strong>5,623</strong></td></tr>
            </table>
          </div>
          <div>
            <div class="bar-chart">
              <div id="efficiency-savings-chart"></div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-2" style="margin-top: 20px;">
          <div class="stat-box blue">
            <div class="stat-label">Annual Energy Savings</div>
            <div class="stat-value" id="annual-energy-savings">5,623 kWh</div>
            <div class="stat-subtitle">per household</div>
          </div>
          <div class="stat-box green">
            <div class="stat-label">Reduction in Consumption</div>
            <div class="stat-value" id="consumption-reduction-pct">52%</div>
            <div class="stat-subtitle">of household energy use</div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3 class="card-title">Economic Analysis</h3>
        <div class="grid grid-cols-2">
          <div class="stat-box">
            <div class="stat-label">System Cost</div>
            <div class="stat-value" id="system-cost">$29,000</div>
            <div class="stat-subtitle">Before incentives</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">After Incentives</div>
            <div class="stat-value" id="net-system-cost">$19,100</div>
            <div class="stat-subtitle">Net cost</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Annual Savings</div>
            <div class="stat-value" id="annual-cost-savings">$562</div>
            <div class="stat-subtitle">Utility bill reduction</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Payback Period</div>
            <div class="stat-value" id="household-payback">8.5 years</div>
            <div class="stat-subtitle">With incentives</div>
          </div>
        </div>
      </div>
      <div class="card">
        <!-- Fix: Adoption rate display now updates dynamically -->
        <h3 class="card-title">National Impact at <span id="adoption-rate-display">25</span>% Adoption</h3>
        <div class="grid grid-cols-2">
          <div>
            <div class="metric-row">
              <span class="metric-label">Homes Retrofitted:</span>
              <span class="metric-value" id="homes-adopting">32.5 million</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Total Energy Saved:</span>
              <span class="metric-value" id="national-energy-saved">182.7 TWh</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Carbon Reduction:</span>
              <span class="metric-value" id="efficiency-carbon-reduction">76.2 million tons</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">% of US Emissions:</span>
              <span class="metric-value" id="efficiency-emission-percent">1.46%</span>
            </div>
          </div>
          <div>
            <div class="metric-row">
              <span class="metric-label">Grid Capacity Freed:</span>
              <span class="metric-value" id="grid-capacity-freed">4.8%</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">EVs Supported:</span>
              <span class="metric-value" id="evs-supported">65.4 million</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Total Investment:</span>
              <span class="metric-value" id="efficiency-investment">$621.0 billion</span>
            </div>
            <div class="metric-row">
              <span class="metric-label">Jobs Created:</span>
              <span class="metric-value" id="efficiency-jobs">3.1 million</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- RENEWABLE TAB (Unchanged) -->
    <div class="tab-content" id="renewable">
      <div class="card">
        <h3 class="card-title">Renewable Energy Generation</h3>
        <p>This tab would show detailed information about renewable energy production from waste streams, algae, SkySails wind, <strong>and now also Solar & Nuclear</strong>.</p>
        <div id="renewable-placeholder">
          <div class="center-text">
            <p>Detailed metrics are being calculated based on your input parameters.</p>
            <p>The full calculator shows comprehensive analysis of:</p>
            <ul>
              <li>Energy generation by source (including solar, nuclear, wastes, algae, SkySails)</li>
              <li>Waste utilization rates</li>
              <li>Carbon sequestration and avoidance</li>
              <li>Economic impacts and ROI</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- TRANSPORT TAB (Unchanged) -->
    <div class="tab-content" id="transport">
      <div class="card">
        <h3 class="card-title">Transportation Impact</h3>
        <p>This tab would show detailed information about transportation improvements including fleet retrofits, biofuels, and oil import reductions.</p>
        <div id="transport-placeholder">
          <div class="center-text">
            <p>Detailed transportation metrics are being calculated.</p>
            <p>The full calculator integrates:</p>
            <ul>
              <li>Vehicle fleet retrofit impacts</li>
              <li>Carbon capture utilization</li>
              <li>Biofuel production from hemp and algae</li>
              <li>Oil import reduction analysis</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- WATER TAB (Unchanged) -->
    <div class="tab-content" id="water">
      <div class="card">
        <h3 class="card-title">Water Production Impact</h3>
        <p>This tab would show detailed information about water systems including desalination, atmospheric water generation, and agricultural impacts.</p>
        <div id="water-placeholder">
          <div class="center-text">
            <p>Water system metrics are being calculated.</p>
            <p>The full calculator analyzes:</p>
            <ul>
              <li>Solar-powered desalination</li>
              <li>Atmospheric water harvesting</li>
              <li>Water-energy-food nexus</li>
              <li>Population served and agricultural potential</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- PHASED IMPLEMENTATION TAB (Unchanged) -->
    <div class="tab-content" id="phased">
      <div class="card">
        <h3 class="card-title">Phased Implementation Timeline</h3>
        <table>
          <thead>
          <tr>
            <th>Phase</th>
            <th>Year</th>
            <th>Carbon Reduction (MT)</th>
            <th>Investment ($B)</th>
            <th>Energy Impact (TWh)</th>
            <th>Jobs (millions)</th>
          </tr>
          </thead>
          <tbody id="phased-plan-table"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="action-buttons">
    <button id="export-button">Export Results</button>
    <button class="secondary" id="reset-button">Reset Parameters</button>
  </div>
</div>

<script>
// Dark Mode Toggle
document.getElementById('dark-mode-toggle').addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
});

// Tab Switching Logic
document.querySelectorAll('.tab-button').forEach(button => {
  button.addEventListener('click', () => {
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    button.classList.add('active');
    document.getElementById(button.dataset.tab).classList.add('active');
  });
});

// Implementation Type Toggle
document.getElementById('retrofit-button').addEventListener('click', function() {
  this.classList.add('active');
  document.getElementById('new-construction-button').classList.remove('active');
});
document.getElementById('new-construction-button').addEventListener('click', function() {
  this.classList.add('active');
  document.getElementById('retrofit-button').classList.remove('active');
});

// Data Constants
const usData = {
  population: 332.8,
  electricityConsumption: 3800,
  residentialConsumption: 1470,
  commercialConsumption: 1330,
  industrialConsumption: 1000,
  totalEnergyConsumption: 100,
  foodWaste: 63,
  agriculturalWaste: 800,
  municipalSolidWaste: 292,
  forestResidues: 93,
  constructionWaste: 600,
  co2Emissions: 5222,
  totalWaterWithdrawals: 450,
  publicWaterSupply: 42,
  households: 129.9,
  totalVehicles: 290,
  averageHouseholdConsumption: 10715,
  fuelImports: 9,
};

// Utility for Formatting
function formatNumber(num, decimals = 2) {
  if (num === undefined || num === null) return 'N/A';
  if (num === 0) return '0';
  if (Math.abs(num) < 1000) return parseFloat(num.toFixed(decimals));
  return num.toLocaleString(undefined, {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  });
}

// Sliders
const parameterSliders = [
  'passive-solar-efficiency','gshp-cop','hpwh-efficiency','efficiency-adoption-rate',
  'food-waste-utilization','agriculture-utilization','forest-utilization','msw-utilization',
  'skysails-units','electricity-price','retrofit-percentage','ccu-adoption',
  'hemp-utilization','algae-percentage','energy-allocation-to-water','desalination-allocation',
  'water-techs-efficiency','water-value-usd','implementation-speed','solar-capacity','solar-cost',
  'nuclear-capacity','nuclear-cost'
];

parameterSliders.forEach(id => {
  const slider = document.getElementById(id);
  const displaySpan = document.getElementById(`${id}-value`);
  if (slider) {
    slider.addEventListener('input', () => {
      let val = slider.value;
      if (id === 'skysails-units') {
        val = parseInt(val).toLocaleString();
      } else if (id === 'water-value-usd') {
        val = `$${parseFloat(val).toFixed(2)}`;
      } else if (
        id.includes('efficiency') || id.includes('utilization') || 
        id.includes('percentage') || id.includes('adoption') || 
        id.includes('allocation')
      ) {
        val = `${val}%`;
      } else if (id === 'gshp-cop') {
        val = parseFloat(val).toFixed(1);
      } else if (id === 'hpwh-efficiency') {
        val = `${parseFloat(val).toFixed(1)}x`;
      } else if (id === 'electricity-price') {
        val = `${val}¢`;
      } else if (id === 'solar-capacity' || id === 'nuclear-capacity') {
        val = `${val} GW`;
      } else if (id === 'solar-cost' || id === 'nuclear-cost') {
        val = `$${val}/kW`;
      }
      if (displaySpan) displaySpan.textContent = val;
    });
  }
});

// Calculation Functions (Unchanged)
function calculateSolarNuclearEnergy(solarGW, solarCost, nuclearGW, nuclearCost, electricityPrice) {
  const hoursPerYear = 8760;
  const solarCF = 0.25;
  const nuclearCF = 0.90;
  const solarEnergyTWh = (solarGW * hoursPerYear * solarCF) / 1000;
  const nuclearEnergyTWh = (nuclearGW * hoursPerYear * nuclearCF) / 1000;
  const totalEnergy = solarEnergyTWh + nuclearEnergyTWh;
  const solarInvestment = (solarGW * 1_000_000 * solarCost) / 1_000_000_000;
  const nuclearInvestment = (nuclearGW * 1_000_000 * nuclearCost) / 1_000_000_000;
  const totalInvestment = solarInvestment + nuclearInvestment;
  const carbonAvoided = (totalEnergy * 1_000_000 * 0.4) / 1_000_000;
  const jobs = Math.round(totalInvestment * 1000);
  const annualRevenue = (totalEnergy * 1_000_000_000 * (electricityPrice / 100)) / 1_000_000_000;
  const operatingCost = totalInvestment * 0.03;
  const netAnnualRevenue = annualRevenue - operatingCost;
  let payback = 0;
  if (netAnnualRevenue > 0) payback = totalInvestment / netAnnualRevenue;
  return {
    solarEnergyTWh, nuclearEnergyTWh, totalEnergy,
    solarInvestment, nuclearInvestment, totalInvestment,
    carbonAvoided, jobs, annualRevenue, operatingCost,
    netAnnualRevenue, payback
  };
}

function calculateEfficiencySavings(passiveSolarEfficiency, gshpCOP, hpwhEfficiency, efficiencyAdoptionRate, isNewConstruction, electricityPrice) {
  const originalSpaceHeating = 4500;
  const originalCooling = 643;
  const originalWaterHeating = 1928;
  const originalDryer = 536;
  const passiveSolarSavings = originalSpaceHeating * (passiveSolarEfficiency / 100);
  const remainingHeatingLoad = originalSpaceHeating - passiveSolarSavings;
  const gshpHeatingElectricity = remainingHeatingLoad / gshpCOP;
  const gshpHeatingSavings = remainingHeatingLoad - gshpHeatingElectricity;
  const gshpCoolingElectricity = originalCooling / gshpCOP;
  const gshpCoolingSavings = originalCooling - gshpCoolingElectricity;
  const hpwhConsumption = originalWaterHeating / hpwhEfficiency;
  const hpwhSavings = originalWaterHeating - hpwhConsumption;
  const drySavings = originalDryer * 0.28;
  const totalHeatingDSavings = passiveSolarSavings + gshpHeatingSavings;
  const totalSavings = totalHeatingDSavings + gshpCoolingSavings + hpwhSavings + drySavings;
  const percentageReduction = (totalSavings / usData.averageHouseholdConsumption) * 100;
  const passiveSolarCost = isNewConstruction ? 8000 : 18000;
  const geothermalInstallCost = 18000;
  const hpwhCost = 1800;
  const heatPumpDryerCost = 1200;
  const totalSystemCost = passiveSolarCost + geothermalInstallCost + hpwhCost + heatPumpDryerCost;
  const federalTaxCredit = (passiveSolarCost + geothermalInstallCost) * 0.30;
  const stateRebate = 3000;
  const utilityRebate = 2000;
  const totalIncentives = federalTaxCredit + stateRebate + utilityRebate;
  const netSystemCost = totalSystemCost - totalIncentives;
  const annualCostSavings = totalSavings * (electricityPrice / 100);
  const netPayback = netSystemCost / annualCostSavings;
  const homesAdopting = usData.households * (efficiencyAdoptionRate / 100);
  const totalEnergySaved = (homesAdopting * totalSavings) / 1e9;
  const carbonReductionPerHousehold = (totalSavings * 0.417) / 1000;
  const totalCarbonReduction = (homesAdopting * carbonReductionPerHousehold) / 1e6;
  const percentOfUSEmissions = (totalCarbonReduction / usData.co2Emissions) * 100;
  const evAnnualUsage = 2800;
  const evsPerHousehold = totalSavings / evAnnualUsage;
  const totalEvsSupported = homesAdopting * evsPerHousehold;
  const gridCapacityFreed = (totalEnergySaved / usData.electricityConsumption) * 100;
  const totalNationalInvestment = (homesAdopting * netSystemCost) / 1e9;
  const jobsCreated = Math.round(((homesAdopting * netSystemCost) / 1e6) * 5);
  return {
    perHousehold: {
      passiveSolarSavings, gshpHeatingSavings, gshpCoolingSavings,
      hpwhSavings, drySavings, totalSavings, percentageReduction,
      systemCost: totalSystemCost, netSystemCost, annualCostSavings,
      paybackPeriod: netPayback
    },
    national: {
      homesAdopting, totalEnergySaved, totalCarbonReduction,
      percentOfUSEmissions, totalEvsSupported, gridCapacityFreed,
      totalInvestment: totalNationalInvestment, jobsCreated,
      annualSavings: (homesAdopting * annualCostSavings) / 1e9
    }
  };
}

function calculateEnergyGeneration(foodWasteUtil, agWasteUtil, forestUtil, mswUtil, skySailsUnits, electricityPrice, hempUtil, algaeUtil) {
  const usableFoodWaste = usData.foodWaste * (foodWasteUtil / 100);
  const usableAgWaste = usData.agriculturalWaste * (agWasteUtil / 100);
  const usableForestWaste = usData.forestResidues * (forestUtil / 100);
  const usableMSW = usData.municipalSolidWaste * (mswUtil / 100);
  const foodWasteToEnergy = 1.5;
  const agriculturalWasteToEnergy = 1.2;
  const forestResiduesToEnergy = 2.0;
  const mswToEnergy = 0.6;
  const energyFromFoodWaste = (usableFoodWaste * foodWasteToEnergy) / 1e6;
  const energyFromAgWaste = (usableAgWaste * agriculturalWasteToEnergy) / 1e6;
  const energyFromForestWaste = (usableForestWaste * forestResiduesToEnergy) / 1e6;
  const energyFromMSW = (usableMSW * mswToEnergy) / 1e6;
  const totalBiogas = 0.8;
  const energyFromBiogas = 0.8;
  const algaeBase = 28;
  const energyFromAlgae = (algaeUtil / 25) * algaeBase * 4;
  const hempBase = 3.3;
  const energyFromHemp = (hempUtil / 50) * hempBase * 2;
  const wasteToEnergyTotal = energyFromFoodWaste + energyFromAgWaste + energyFromForestWaste + energyFromMSW + energyFromBiogas;
  const biofuelsTotal = energyFromAlgae + energyFromHemp;
  const skySailsPerUnit = 0.001;
  const energyFromSkySails = skySailsUnits * skySailsPerUnit;
  const totalEnergyGeneration = wasteToEnergyTotal + biofuelsTotal + energyFromSkySails;
  const carbonAvoidance = totalEnergyGeneration * 0.417;
  const carbonSequestration = 20;
  const totalCarbonImpact = carbonSequestration + carbonAvoidance;
  const wasteToEnergyCost = 20;
  const skySailsCost = 10;
  const batteryCost = 30;
  const algaeFacilitiesCost = 5;
  const totalInvestment = wasteToEnergyCost + skySailsCost + batteryCost + algaeFacilitiesCost;
  const electricityRevenueRate = electricityPrice / 100;
  const electricityRevenue = totalEnergyGeneration * 1000 * electricityRevenueRate;
  const carbonCreditValue = (totalCarbonImpact * 30) / 1000;
  const totalRevenue = electricityRevenue + carbonCreditValue;
  const operatingCost = totalInvestment * 0.05;
  const netAnnualRevenue = totalRevenue - operatingCost;
  const paybackPeriod = netAnnualRevenue > 0 ? totalInvestment / netAnnualRevenue : 0;
  const jobsCreated = Math.round(totalInvestment * 1000 * 3);
  return {
    energyGeneration: { total: totalEnergyGeneration },
    carbonImpact: { total: totalCarbonImpact },
    economics: { totalInvestment, netAnnualRevenue, paybackPeriod, jobsCreated }
  };
}

function calculateTransportationImpact(retrofitPct, ccuPct, hempPct, algaePct, electricityPrice) {
  const fleetBaseReduction = 366.85;
  const fleetCarbonReduction = (retrofitPct / 50) * fleetBaseReduction;
  const ccuBaseReduction = 40.5;
  const ccuCarbonReduction = (ccuPct / 90) * ccuBaseReduction;
  const hempBaseReduction = 3.78;
  const hempCarbonReduction = ((hempPct / 50) * hempBaseReduction) * 2;
  const algaeBaseReduction = 67;
  const algaeCarbonReduction = ((algaePct / 25) * algaeBaseReduction) * 4;
  const totalCarbonReduction = fleetCarbonReduction + ccuCarbonReduction + hempCarbonReduction + algaeCarbonReduction;
  const percentOfUSEmissions = (totalCarbonReduction / usData.co2Emissions) * 100;
  const retrofitCost = (retrofitPct / 50) * 145;
  const ccuCost = (ccuPct / 90) * 2.43;
  const totalTransportationCost = retrofitCost + ccuCost;
  const algaeRevenue = ((algaePct / 25) * 5) * 4;
  const hempRevenue = ((hempPct / 50) * 0.09) * 2;
  const carbonCredit = (totalCarbonReduction * 30) / 1000;
  const oilImportReduction = (retrofitPct / 50) * 3.6;
  const oilSavings = (oilImportReduction * 365 * 70) / 1000;
  const totalTransportationRevenue = algaeRevenue + hempRevenue + carbonCredit + oilSavings;
  const netBenefit = totalTransportationRevenue - totalTransportationCost;
  const paybackPeriod = totalTransportationCost > 0 ? totalTransportationCost / totalTransportationRevenue : 0;
  const algaeJobs = ((algaePct / 25) * 60000) * 4;
  const hempJobs = ((hempPct / 50) * 895) * 2;
  const retrofitJobs = (retrofitPct / 50) * 50000;
  const totalTransportationJobs = algaeJobs + hempJobs + retrofitJobs;
  return {
    carbonReduction: { total: totalCarbonReduction, percentOfUSEmissions },
    economics: { cost: totalTransportationCost, netBenefit, paybackPeriod },
    jobs: totalTransportationJobs
  };
}

function calculateWaterProduction(energyData, energyAllocationPct, desalAllocation, waterTechEff, waterValueUSD) {
  const allocatedEnergy = energyData.energyGeneration.total * (energyAllocationPct / 100);
  const energyForDesal = allocatedEnergy * (desalAllocation / 100);
  const energyForAWG = allocatedEnergy * (1 - (desalAllocation / 100));
  const efficiencyFactor = waterTechEff / 100;
  const desalIntensity = 3.0;
  const awgIntensity = 1.5;
  const desalProd = (energyForDesal * 1e9 * efficiencyFactor) / desalIntensity;
  const awgProd = (energyForAWG * 1e9 * efficiencyFactor) / awgIntensity;
  const totalWaterProduction = desalProd + awgProd;
  const populationServed = totalWaterProduction / 365 / 100;
  const percentOfTotalWithdrawals = (totalWaterProduction / 1e9) / usData.totalWaterWithdrawals * 100;
  const desalCapCost = 15000;
  const awgCapCost = 1000;
  const desalInvest = ((desalProd / 365)/1000) * desalCapCost / 1e3;
  const awgInvest = ((awgProd / 365)/1000) * awgCapCost / 1e3;
  const totalInvestment = desalInvest + awgInvest;
  const waterVal = (totalWaterProduction / 1e6) * waterValueUSD;
  const desalOpex = 0.5;
  const awgOpex = 0.3;
  const operatingCost = ((desalProd / 1e6) * desalOpex) + ((awgProd / 1e6) * awgOpex);
  const netAnnualValue = waterVal - operatingCost;
  const paybackPeriod = (totalInvestment > 0 && netAnnualValue > 0) ? totalInvestment / netAnnualValue : 0;
  const carbonReduction = (totalWaterProduction / 1e6) * 0.5;
  const jobsCreated = Math.round(totalInvestment * 1000 * 2);
  return {
    energy: { allocated: allocatedEnergy },
    production: { total: totalWaterProduction / 1e6 },
    impact: { populationServed: populationServed / 1e6, percentOfTotalWithdrawals },
    economics: { totalInvestment, operatingCost, netAnnualValue, paybackPeriod, jobsCreated, waterValue: waterVal },
    carbon: { reduction: carbonReduction, percentOfUSEmissions: (carbonReduction / usData.co2Emissions) * 100 }
  };
}

// Update UI Functions
function updateEfficiencyUI(efficiencyResults) {
  document.getElementById('passive-solar-savings').textContent = formatNumber(efficiencyResults.perHousehold.passiveSolarSavings, 0);
  document.getElementById('gshp-heating-savings').textContent = formatNumber(efficiencyResults.perHousehold.gshpHeatingSavings, 0);
  document.getElementById('gshp-cooling-savings').textContent = formatNumber(efficiencyResults.perHousehold.gshpCoolingSavings, 0);
  document.getElementById('hpwh-savings').textContent = formatNumber(efficiencyResults.perHousehold.hpwhSavings, 0);
  document.getElementById('dry-savings').textContent = formatNumber(efficiencyResults.perHousehold.drySavings, 0);
  document.getElementById('total-household-savings').textContent = formatNumber(efficiencyResults.perHousehold.totalSavings, 0);
  document.getElementById('annual-energy-savings').textContent = `${formatNumber(efficiencyResults.perHousehold.totalSavings,0)} kWh`;
  document.getElementById('consumption-reduction-pct').textContent = `${formatNumber(efficiencyResults.perHousehold.percentageReduction,0)}%`;
  document.getElementById('system-cost').textContent = `$${formatNumber(efficiencyResults.perHousehold.systemCost,0)}`;
  document.getElementById('net-system-cost').textContent = `$${formatNumber(efficiencyResults.perHousehold.netSystemCost,0)}`;
  document.getElementById('annual-cost-savings').textContent = `$${formatNumber(efficiencyResults.perHousehold.annualCostSavings,0)}`;
  document.getElementById('household-payback').textContent = `${formatNumber(efficiencyResults.perHousehold.paybackPeriod,1)} years`;
  const nat = efficiencyResults.national;
  document.getElementById('homes-adopting').textContent = `${formatNumber(nat.homesAdopting / 1e6,1)} million`;
  document.getElementById('national-energy-saved').textContent = `${formatNumber(nat.totalEnergySaved,1)} TWh`;
  document.getElementById('efficiency-carbon-reduction').textContent = `${formatNumber(nat.totalCarbonReduction,2)} million tons`;
  document.getElementById('efficiency-emission-percent').textContent = `${formatNumber(nat.percentOfUSEmissions,2)}%`;
  document.getElementById('grid-capacity-freed').textContent = `${formatNumber(nat.gridCapacityFreed,1)}%`;
  document.getElementById('evs-supported').textContent = `${formatNumber(nat.totalEvsSupported / 1e6,1)} million`;
  document.getElementById('efficiency-investment').textContent = `$${formatNumber(nat.totalInvestment,1)} billion`;
  document.getElementById('efficiency-jobs').textContent = `${formatNumber(nat.jobsCreated / 1e6,1)} million`;
  updateEfficiencySavingsChart(efficiencyResults);
}

function updateEfficiencyMetrics(efficiencyResults) {
  const container = document.getElementById('efficiency-metrics');
  if (!container) return;
  const nat = efficiencyResults.national;
  // Optional debug log (uncomment to test in browser)
  // console.log('Updating efficiency metrics with:', nat);
  container.innerHTML = `
    <div class="metric-row">
      <span class="metric-label">Total Energy Saved (TWh):</span>
      <span class="metric-value">${formatNumber(nat.totalEnergySaved,1)}</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Carbon Reduction (MT):</span>
      <span class="metric-value">${formatNumber(nat.totalCarbonReduction,2)}</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Jobs Created:</span>
      <span class="metric-value">${formatNumber(nat.jobsCreated / 1e6,1)}M</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Investment (B):</span>
      <span class="metric-value">$${formatNumber(nat.totalInvestment,2)}</span>
    </div>
  `;
}

function updateRenewablesUI(renewableResults, solarNuclearResults) {
  const container = document.getElementById('renewable-metrics');
  if (!container) return;
  const totalTWh = renewableResults.energyGeneration.total + solarNuclearResults.totalEnergy;
  const totalInvest = (renewableResults.economics.totalInvestment || 0) + solarNuclearResults.totalInvestment;
  const totalCarbon = (renewableResults.carbonImpact?.total || 0) + solarNuclearResults.carbonAvoided;
  const totalJobs = (renewableResults.economics.jobsCreated || 0) + solarNuclearResults.jobs;
  const percentEmissions = (totalCarbon / usData.co2Emissions) * 100;
  container.innerHTML = `
    <div class="metric-row">
      <span class="metric-label">Waste & Bio-based TWh:</span>
      <span class="metric-value">${formatNumber(renewableResults.energyGeneration.total,2)} TWh</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Solar TWh:</span>
      <span class="metric-value">${formatNumber(solarNuclearResults.solarEnergyTWh,2)} TWh</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Nuclear TWh:</span>
      <span class="metric-value">${formatNumber(solarNuclearResults.nuclearEnergyTWh,2)} TWh</span>
    </div>
    <div class="metric-row">
      <span class="metric-label"><strong>Total Renewable & Clean TWh:</strong></span>
      <span class="metric-value"><strong>${formatNumber(totalTWh,2)}</strong></span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Solar & Nuclear Investment:</span>
      <span class="metric-value">$${formatNumber(solarNuclearResults.totalInvestment,2)} B</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Total Renewables Investment:</span>
      <span class="metric-value">$${formatNumber(totalInvest,2)} B</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Jobs (Renewables + Solar/Nuclear):</span>
      <span class="metric-value">${formatNumber(totalJobs,0)}</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Carbon Reduction (Renewables + Solar/Nuclear):</span>
      <span class="metric-value">${formatNumber(totalCarbon,2)} MT</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">(% of US Emissions):</span>
      <span class="metric-value">${formatNumber(percentEmissions,2)}%</span>
    </div>
  `;
}

function updateWaterUI(waterResults) {
  const container = document.getElementById('water-metrics');
  if (!container) return;
  container.innerHTML = `
    <div class="metric-row">
      <span class="metric-label">Total Water Production:</span>
      <span class="metric-value">${formatNumber(waterResults.production.total,2)} million m³/yr</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Population Served:</span>
      <span class="metric-value">${formatNumber(waterResults.impact.populationServed,2)} million</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">% of US Withdrawals:</span>
      <span class="metric-value">${formatNumber(waterResults.impact.percentOfTotalWithdrawals,2)}%</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Total Investment:</span>
      <span class="metric-value">$${formatNumber(waterResults.economics.totalInvestment,2)} B</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Annual Water Value:</span>
      <span class="metric-value">$${formatNumber(waterResults.economics.waterValue,2)} B</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Operating Cost:</span>
      <span class="metric-value">$${formatNumber(waterResults.economics.operatingCost,2)} B</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Payback Period:</span>
      <span class="metric-value">${formatNumber(waterResults.economics.paybackPeriod,1)} years</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Jobs Created:</span>
      <span class="metric-value">${formatNumber(waterResults.economics.jobsCreated,0)}</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Carbon Reduction:</span>
      <span class="metric-value">${formatNumber(waterResults.carbon.reduction,2)} MT</span>
    </div>
  `;
}

function updateEfficiencySavingsChart(efficiencyResults) {
  const container = document.getElementById('efficiency-savings-chart');
  container.innerHTML = '';
  const data = [
    { name: 'Passive Solar', value: efficiencyResults.perHousehold.passiveSolarSavings },
    { name: 'GSHP Heating', value: efficiencyResults.perHousehold.gshpHeatingSavings },
    { name: 'GSHP Cooling', value: efficiencyResults.perHousehold.gshpCoolingSavings },
    { name: 'HP Water Heater', value: efficiencyResults.perHousehold.hpwhSavings },
    { name: 'HP Dryer', value: efficiencyResults.perHousehold.drySavings }
  ];
  const total = efficiencyResults.perHousehold.totalSavings;
  const colors = ['#0088FE','#00C49F','#FFBB28','#FF8042','#8884d8'];
  data.forEach((item, i) => {
    const bar = document.createElement('div');
    bar.className = 'bar';
    const barFill = document.createElement('div');
    barFill.className = 'bar-fill';
    barFill.style.width = `${(item.value / total)*100}%`;
    barFill.style.backgroundColor = colors[i % colors.length];
    const barLabel = document.createElement('div');
    barLabel.className = 'bar-label';
    barLabel.textContent = item.name;
    const barValue = document.createElement('div');
    barValue.className = 'bar-value';
    const pct = (item.value / total)*100;
    barValue.textContent = `${formatNumber(item.value,0)} kWh (${formatNumber(pct,0)}%)`;
    bar.appendChild(barFill);
    bar.appendChild(barLabel);
    bar.appendChild(barValue);
    container.appendChild(bar);
  });
}

function updateCarbonBreakdownChart(carbonData) {
  const container = document.getElementById('carbon-breakdown');
  if (!container) return;
  container.innerHTML = '';
  const total = carbonData.reduce((sum, d) => sum + d.value, 0);
  const colors = ['#dc2626','#16a34a','#1d4ed8','#d97706','#6d28d9'];
  carbonData.forEach((item, i) => {
    const bar = document.createElement('div');
    bar.className = 'bar';
    const barFill = document.createElement('div');
    barFill.className = 'bar-fill';
    const widthPct = (total > 0) ? (item.value / total) * 100 : 0;
    barFill.style.width = `${widthPct}%`;
    barFill.style.backgroundColor = colors[i % colors.length];
    const barLabel = document.createElement('div');
    barLabel.className = 'bar-label';
    barLabel.textContent = item.name;
    const barValue = document.createElement('div');
    barValue.className = 'bar-value';
    const pct = (widthPct).toFixed(1);
    barValue.textContent = `${formatNumber(item.value,1)} MT (${pct}%)`;
    bar.appendChild(barFill);
    bar.appendChild(barLabel);
    bar.appendChild(barValue);
    container.appendChild(bar);
  });
}

// Phased Plan Functions
function generatePhasedPlan(effResults, renResults, transResults, waterResults, snResults, effFirst) {
  const effPhases = [0.05, 0.1, 0.2, 0.4, 0.7, 1.0];
  const genPhases = [0.0, 0.05, 0.2, 0.5, 0.8, 1.0];
  const speed = parseFloat(document.getElementById('implementation-speed').value);
  const speedFactor = speed / 10;
  const baseYearIncrement = 3 / speedFactor;
  const phases = effFirst
    ? effPhases.map((effF, i) => {
        const year = 2025 + Math.floor(i*baseYearIncrement);
        const genF = genPhases[Math.max(0, i-1)];
        return {
          year, phase: i+1,
          efficiencyFactor: effF,
          generationFactor: genF,
          transportationFactor: genF,
          waterFactor: i>=3 ? genPhases[i-2] : 0
        };
      })
    : genPhases.map((genF, i) => {
        const year = 2025 + Math.floor(i*baseYearIncrement);
        const effF = effPhases[Math.max(0, i-2)];
        return {
          year, phase: i+1,
          efficiencyFactor: effF,
          generationFactor: genF,
          transportationFactor: genF,
          waterFactor: i>=2 ? genPhases[i-1] : 0
        };
      });
  const eNat = effResults.national;
  return phases.map(p => {
    const effSaves = eNat.totalEnergySaved * p.efficiencyFactor;
    const effCO2 = eNat.totalCarbonReduction * p.efficiencyFactor;
    const effInv = eNat.totalInvestment * p.efficiencyFactor;
    const effJobs = eNat.jobsCreated * p.efficiencyFactor;
    const rTotal = renResults.energyGeneration.total * p.generationFactor;
    const rCO2 = (renResults.carbonImpact?.total || 0) * p.generationFactor;
    const rInv = (renResults.economics?.totalInvestment || 0) * p.generationFactor;
    const rJobs = (renResults.economics?.jobsCreated || 0) * p.generationFactor;
    const snE = snResults.totalEnergy * p.generationFactor;
    const snCO2 = snResults.carbonAvoided * p.generationFactor;
    const snInv = snResults.totalInvestment * p.generationFactor;
    const snJobs = snResults.jobs * p.generationFactor;
    const tCO2 = transResults.carbonReduction.total * p.transportationFactor;
    const tInv = transResults.economics.cost * p.transportationFactor;
    const tJobs = transResults.jobs * p.transportationFactor;
    const wProd = waterResults.production.total * p.waterFactor;
    const wCO2 = waterResults.carbon.reduction * p.waterFactor;
    const wInv = waterResults.economics.totalInvestment * p.waterFactor;
    const wJobs = waterResults.economics.jobsCreated * p.waterFactor;
    const totalEnergyGen = rTotal + snE;
    const totalCarbon = effCO2 + rCO2 + snCO2 + tCO2 + wCO2;
    const totalInvestment = effInv + rInv + snInv + tInv + wInv;
    const totalJobs = effJobs + rJobs + snJobs + tJobs + wJobs;
    const netEnergy = totalEnergyGen - effSaves;
    return {
      year: p.year,
      phase: p.phase,
      totals: {
        investment: totalInvestment,
        carbonReduction: totalCarbon,
        jobs: totalJobs,
        netEnergyImpact: netEnergy,
        percentOfUSEmissions: (totalCarbon / usData.co2Emissions)*100
      }
    };
  });
}

function updatePhasedPlanTable(plan) {
  const body = document.getElementById('phased-plan-table');
  body.innerHTML = '';
  plan.forEach(ph => {
    const row = document.createElement('tr');
    const cPhase = document.createElement('td'); cPhase.textContent = ph.phase;
    const cYear = document.createElement('td'); cYear.textContent = ph.year;
    const cCO2 = document.createElement('td'); cCO2.textContent = formatNumber(ph.totals.carbonReduction);
    const cInv = document.createElement('td'); cInv.textContent = formatNumber(ph.totals.investment);
    const cEn = document.createElement('td'); cEn.textContent = formatNumber(ph.totals.netEnergyImpact);
    const cJobs = document.createElement('td'); cJobs.textContent = formatNumber(ph.totals.jobs/1e6,2);
    row.appendChild(cPhase);
    row.appendChild(cYear);
    row.appendChild(cCO2);
    row.appendChild(cInv);
    row.appendChild(cEn);
    row.appendChild(cJobs);
    body.appendChild(row);
  });
}

// Main Update Function with Fixes and Enhancements
function updateCalculations() {
  const passiveSolarEff = parseFloat(document.getElementById('passive-solar-efficiency').value);
  const gshpCOP = parseFloat(document.getElementById('gshp-cop').value);
  const hpwhEff = parseFloat(document.getElementById('hpwh-efficiency').value);
  const effAdoptionRate = parseFloat(document.getElementById('efficiency-adoption-rate').value);
  const isNewConstruction = document.getElementById('new-construction-button').classList.contains('active');
  const foodUtil = parseFloat(document.getElementById('food-waste-utilization').value);
  const agUtil = parseFloat(document.getElementById('agriculture-utilization').value);
  const forestUtil = parseFloat(document.getElementById('forest-utilization').value);
  const mswUtil = parseFloat(document.getElementById('msw-utilization').value);
  const skySails = parseFloat(document.getElementById('skysails-units').value);
  const elecPrice = parseFloat(document.getElementById('electricity-price').value);
  const retrofitPct = parseFloat(document.getElementById('retrofit-percentage').value);
  const ccuAdoption = parseFloat(document.getElementById('ccu-adoption').value);
  const hempUtil = parseFloat(document.getElementById('hemp-utilization').value);
  const algaePct = parseFloat(document.getElementById('algae-percentage').value);
  const waterAlloc = parseFloat(document.getElementById('energy-allocation-to-water').value);
  const desalAlloc = parseFloat(document.getElementById('desalination-allocation').value);
  const waterTechEff = parseFloat(document.getElementById('water-techs-efficiency').value);
  const waterValUSD = parseFloat(document.getElementById('water-value-usd').value);
  const solarGW = parseFloat(document.getElementById('solar-capacity').value);
  const solarCost = parseFloat(document.getElementById('solar-cost').value);
  const nuclearGW = parseFloat(document.getElementById('nuclear-capacity').value);
  const nuclearCost = parseFloat(document.getElementById('nuclear-cost').value);
  const effFirst = (document.getElementById('efficiency-first-toggle').value === "1");
  
  // Fix: Update adoption rate display in Efficiency tab
  document.getElementById('adoption-rate-display').textContent = effAdoptionRate;
  
  const effResults = calculateEfficiencySavings(passiveSolarEff, gshpCOP, hpwhEff, effAdoptionRate, isNewConstruction, elecPrice);
  const renResults = calculateEnergyGeneration(foodUtil, agUtil, forestUtil, mswUtil, skySails, elecPrice, hempUtil, algaePct);
  renResults.carbonImpact = { total: (renResults.energyGeneration.total * 0.417 + 20) };
  renResults.economics = { totalInvestment: 100, jobsCreated: 500000 };
  const solarNuclear = calculateSolarNuclearEnergy(solarGW, solarCost, nuclearGW, nuclearCost, elecPrice);
  const transResults = calculateTransportationImpact(retrofitPct, ccuAdoption, hempUtil, algaePct, elecPrice);
  if (!transResults.economics) {
    transResults.economics = { cost:0, netBenefit:0, paybackPeriod:0 };
  }
  const waterRes = calculateWaterProduction(renResults, waterAlloc, desalAlloc, waterTechEff, waterValUSD);
  
  updateEfficiencyUI(effResults);
  updateEfficiencyMetrics(effResults);
  updateRenewablesUI(renResults, solarNuclear);
  updateWaterUI(waterRes);
  
  const totalCleanEnergy = renResults.energyGeneration.total + solarNuclear.totalEnergy;
  const totalRenewCarbon = (renResults.carbonImpact.total || 0) + (solarNuclear.carbonAvoided || 0);
  const totalTransCarbon = transResults.carbonReduction.total || 0;
  const totalWaterCarbon = waterRes.carbon.reduction || 0;
  const netEnergyImpact = totalCleanEnergy - effResults.national.totalEnergySaved;
  const totalCarbonReduction = effResults.national.totalCarbonReduction + totalRenewCarbon + totalTransCarbon + totalWaterCarbon;
  const effInv = effResults.national.totalInvestment || 0;
  const renInv = renResults.economics.totalInvestment || 0;
  const snInv = solarNuclear.totalInvestment || 0;
  const transC = transResults.economics.cost || 0;
  const waterI = waterRes.economics.totalInvestment || 0;
  const totalInvestment = effInv + renInv + snInv + transC + waterI;
  const effJobs = effResults.national.jobsCreated || 0;
  const renJobs = renResults.economics.jobsCreated || 0;
  const snJobs = solarNuclear.jobs || 0;
  const transJobs = transResults.jobs || 0;
  const waterJobs = waterRes.economics.jobsCreated || 0;
  const totalJobs = effJobs + renJobs + snJobs + transJobs + waterJobs;
  const annualBenefits = effResults.national.annualSavings + transResults.economics.netBenefit;
  const payback = (totalInvestment>0 && annualBenefits>0) ? (totalInvestment/annualBenefits) : 0;
  const percentEmissionsReduced = (totalCarbonReduction / usData.co2Emissions)*100;
  
  document.getElementById('net-energy-impact').textContent = `${formatNumber(netEnergyImpact,2)} TWh`;
  document.getElementById('net-energy-percent').textContent = `${formatNumber((netEnergyImpact/usData.electricityConsumption)*100,2)}% of US consumption`;
  document.getElementById('carbon-reduction').textContent = `${formatNumber(totalCarbonReduction,2)} MT`;
  document.getElementById('carbon-percent').textContent = `${formatNumber(percentEmissionsReduced,2)}% of US emissions`;
  document.getElementById('total-investment').textContent = `$${formatNumber(totalInvestment/1000,2)}T`;
  document.getElementById('payback-period').textContent = `Payback: ${formatNumber(payback,1)} years`;
  document.getElementById('jobs-created').textContent = `${formatNumber(totalJobs/1e6,1)}M`;
  if (totalInvestment>0) {
    document.getElementById('jobs-per-million').textContent = `${formatNumber(totalJobs / (totalInvestment*1000),1)} jobs per $1M`;
  } else {
    document.getElementById('jobs-per-million').textContent = '-';
  }
  
  if (effFirst) {
    document.getElementById('eff-first-investment').textContent = `$${formatNumber(totalInvestment/1000,2)}T`;
    document.getElementById('eff-first-carbon').textContent = `${formatNumber(totalCarbonReduction,2)}M tons`;
    document.getElementById('eff-first-payback').textContent = `${formatNumber(payback,1)} years`;
    document.getElementById('eff-first-jobs').textContent = `${formatNumber(totalJobs/1e6,1)}M`;
    document.getElementById('gen-first-investment').textContent = `$${formatNumber((totalInvestment*1.4)/1000,2)}T`;
    document.getElementById('gen-first-carbon').textContent = `${formatNumber(totalCarbonReduction*0.7,2)}M tons`;
    document.getElementById('gen-first-payback').textContent = `${formatNumber(payback*1.8,1)} years`;
    document.getElementById('gen-first-jobs').textContent = `${formatNumber((totalJobs*0.45)/1e6,1)}M`;
  } else {
    document.getElementById('gen-first-investment').textContent = `$${formatNumber(totalInvestment/1000,2)}T`;
    document.getElementById('gen-first-carbon').textContent = `${formatNumber(totalCarbonReduction,2)}M tons`;
    document.getElementById('gen-first-payback').textContent = `${formatNumber(payback,1)} years`;
    document.getElementById('gen-first-jobs').textContent = `${formatNumber(totalJobs/1e6,1)}M`;
    document.getElementById('eff-first-investment').textContent = `$${formatNumber((totalInvestment*0.7)/1000,2)}T`;
    document.getElementById('eff-first-carbon').textContent = `${formatNumber(totalCarbonReduction*1.4,2)}M tons`;
    document.getElementById('eff-first-payback').textContent = `${formatNumber(payback*0.55,1)} years`;
    document.getElementById('eff-first-jobs').textContent = `${formatNumber((totalJobs*2.2)/1e6,1)}M`;
  }
  
  const carbonData = [
    { name: 'Efficiency', value: effResults.national.totalCarbonReduction },
    { name: 'Renewable Energy', value: totalRenewCarbon },
    { name: 'Transportation', value: totalTransCarbon },
    { name: 'Water Systems', value: totalWaterCarbon }
  ];
  updateCarbonBreakdownChart(carbonData);
  
  const phased = generatePhasedPlan(effResults, renResults, transResults, waterRes, solarNuclear, effFirst);
  updatePhasedPlanTable(phased);
  
  // Enhancement: Update last calculated timestamp
  document.getElementById('last-updated').textContent = `Last calculated: ${new Date().toLocaleString()}`;
}

// Buttons
document.getElementById('reset-button').addEventListener('click', () => {
  window.location.reload();
});

document.getElementById('apply-parameters-button').addEventListener('click', () => {
  updateCalculations();
});

document.getElementById('export-button').addEventListener('click', exportResults);

function exportResults() {
  const dataToExport = {
    netEnergyImpact: document.getElementById('net-energy-impact').textContent,
    carbonReduction: document.getElementById('carbon-reduction').textContent,
    totalInvestment: document.getElementById('total-investment').textContent,
    jobsCreated: document.getElementById('jobs-created').textContent,
  };
  const json = JSON.stringify(dataToExport, null, 2);
  const blob = new Blob([json], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'results.json';
  link.click();
  URL.revokeObjectURL(url);
}

// Initial Load
window.onload = updateCalculations;
</script>
</body>
</html>

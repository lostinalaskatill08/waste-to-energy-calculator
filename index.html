import React, { useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { LineChart, Line, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer, BarChart, Bar } from 'recharts';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

const USWasteToEnergyCalculator = () => {
  const [population, setPopulation] = useState('');
  const [results, setResults] = useState(null);
  const [chartData, setChartData] = useState([]);
  const [wasteComposition, setWasteComposition] = useState([]);

  // Constants based on U.S. standards
  const constants = {
    // Waste generation rates (kg/person/year)
    foodWastePerPerson: 435,
    plasticMSWPerPerson: 500,
    humanWastePerPerson: 50,
    agWastePerPerson: 120,
    
    // Energy conversion parameters
    methaneYieldPerTon: 100,
    electricityPerMethaneM3: 10,
    incinerationEfficiency: 0.42,
    gasificationEfficiency: 1.25,
    
    // Environmental factors
    co2EquivalentSaved: 3.5,
    algaePerCo2: 0.25,
    biofuelPerAlgae: 0.6,
    householdEnergyUsage: 10500,
    landfillSpacePerTon: 1.5
  };

  const calculateResults = (processingRate) => {
    if (!population) return null;
    
    const pop = parseFloat(population);
    
    // Convert kg to tons
    const totalFoodWaste = (pop * constants.foodWastePerPerson) / 1000;
    const totalPlasticMSW = (pop * constants.plasticMSWPerPerson) / 1000;
    const totalHumanWaste = (pop * constants.humanWastePerPerson) / 1000;
    const totalAgWaste = (pop * constants.agWastePerPerson) / 1000;

    // Calculate waste composition for visualization
    const totalWaste = totalFoodWaste + totalPlasticMSW + totalHumanWaste + totalAgWaste;
    setWasteComposition([
      { name: 'Food Waste', value: (totalFoodWaste / totalWaste) * 100 },
      { name: 'MSW/Plastic', value: (totalPlasticMSW / totalWaste) * 100 },
      { name: 'Human Waste', value: (totalHumanWaste / totalWaste) * 100 },
      { name: 'Ag/Forest Waste', value: (totalAgWaste / totalWaste) * 100 }
    ]);

    const processedFoodWaste = totalFoodWaste * processingRate;
    const processedPlasticMSW = totalPlasticMSW * processingRate;
    const processedHumanWaste = totalHumanWaste * processingRate;
    const processedAgWaste = totalAgWaste * processingRate;

    // Energy calculations
    const methaneFood = processedFoodWaste * constants.methaneYieldPerTon;
    const methaneHuman = processedHumanWaste * constants.methaneYieldPerTon;
    const electricityFood = methaneFood * constants.electricityPerMethaneM3;
    const electricityHuman = methaneHuman * constants.electricityPerMethaneM3;
    const electricityPlasticMSW = processedPlasticMSW * constants.incinerationEfficiency * 1000;
    const electricityAgWaste = processedAgWaste * constants.gasificationEfficiency * 1000;

    const totalEnergy = (electricityFood + electricityHuman + electricityPlasticMSW + electricityAgWaste) / 1000;
    
    // Calculate revenue potential (approximate U.S. rates)
    const electricityRate = 0.12; // USD per kWh
    const annualRevenue = totalEnergy * 1000 * electricityRate;
    
    return {
      totalEnergy,
      householdsPowered: totalEnergy * 1000 / constants.householdEnergyUsage,
      landfillSpaceSaved: (processedFoodWaste + processedPlasticMSW + processedHumanWaste) * constants.landfillSpacePerTon,
      co2Saved: (processedFoodWaste + processedHumanWaste) * constants.co2EquivalentSaved,
      algaeProduced: (processedFoodWaste + processedHumanWaste) * constants.co2EquivalentSaved * constants.algaePerCo2,
      biofuelProduced: (processedFoodWaste + processedHumanWaste) * constants.co2EquivalentSaved * constants.algaePerCo2 * constants.biofuelPerAlgae,
      annualRevenue,
      energyBreakdown: {
        biogas: (electricityFood + electricityHuman) / 1000,
        incineration: electricityPlasticMSW / 1000,
        gasification: electricityAgWaste / 1000
      }
    };
  };

  const handleCalculate = () => {
    const minProcessing = 0.05;
    const maxProcessing = 1.0;
    
    const minValues = calculateResults(minProcessing);
    const maxValues = calculateResults(maxProcessing);
    
    setResults({ minValues, maxValues });

    // Generate chart data
    const newChartData = [];
    for (let rate = 0.1; rate <= 1; rate += 0.1) {
      const result = calculateResults(rate);
      newChartData.push({
        rate: `${(rate * 100).toFixed(0)}%`,
        energy: result.totalEnergy,
        revenue: result.annualRevenue / 1000000, // Convert to millions
        households: result.householdsPowered
      });
    }
    setChartData(newChartData);
  };

  return (
    <div className="space-y-6 p-4">
      <Card>
        <CardHeader>
          <CardTitle>U.S. Waste-to-Energy Calculator</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-6">
            <div className="flex gap-4">
              <Input
                type="number"
                placeholder="Enter city population"
                value={population}
                onChange={(e) => setPopulation(e.target.value)}
                className="max-w-xs"
              />
              <Button onClick={handleCalculate}>Calculate Potential</Button>
            </div>

            {results && (
              <Tabs defaultValue="overview">
                <TabsList>
                  <TabsTrigger value="overview">Overview</TabsTrigger>
                  <TabsTrigger value="charts">Analysis</TabsTrigger>
                  <TabsTrigger value="environmental">Environmental Impact</TabsTrigger>
                </TabsList>

                <TabsContent value="overview">
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <Card>
                      <CardContent className="pt-6">
                        <h3 className="font-bold mb-2">Energy Generation</h3>
                        <p>‚ö° Total Energy: {results.minValues.totalEnergy.toFixed(1)} - {results.maxValues.totalEnergy.toFixed(1)} MWh</p>
                        <p>üè† Households: {Math.floor(results.minValues.householdsPowered)} - {Math.floor(results.maxValues.householdsPowered)}</p>
                        <p>üí∞ Annual Revenue: ${(results.minValues.annualRevenue/1000000).toFixed(2)}M - ${(results.maxValues.annualRevenue/1000000).toFixed(2)}M</p>
                      </CardContent>
                    </Card>
                    
                    <Card>
                      <CardContent className="pt-6">
                        <h3 className="font-bold mb-2">Environmental Benefits</h3>
                        <p>üåç CO‚ÇÇ Saved: {results.minValues.co2Saved.toFixed(1)} - {results.maxValues.co2Saved.toFixed(1)} tons</p>
                        <p>üöõ Landfill Space: {results.minValues.landfillSpaceSaved.toFixed(1)} - {results.maxValues.landfillSpaceSaved.toFixed(1)} m¬≥</p>
                        <p>üå± Biofuel: {results.minValues.biofuelProduced.toFixed(1)} - {results.maxValues.biofuelProduced.toFixed(1)} tons</p>
                      </CardContent>
                    </Card>

                    <Card>
                      <CardContent className="pt-6">
                        <h3 className="font-bold mb-2">Energy Breakdown (Max)</h3>
                        <p>üîã Biogas: {results.maxValues.energyBreakdown.biogas.toFixed(1)} MWh</p>
                        <p>üî• Incineration: {results.maxValues.energyBreakdown.incineration.toFixed(1)} MWh</p>
                        <p>‚ô®Ô∏è Gasification: {results.maxValues.energyBreakdown.gasification.toFixed(1)} MWh</p>
                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>

                <TabsContent value="charts">
                  <div className="space-y-6">
                    <div className="h-64">
                      <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={chartData}>
                          <XAxis dataKey="rate" />
                          <YAxis yAxisId="left" />
                          <YAxis yAxisId="right" orientation="right" />
                          <Tooltip />
                          <Legend />
                          <Line yAxisId="left" type="monotone" dataKey="energy" stroke="#2563eb" name="Energy (MWh)" />
                          <Line yAxisId="right" type="monotone" dataKey="revenue" stroke="#16a34a" name="Revenue (M$)" />
                        </LineChart>
                      </ResponsiveContainer>
                    </div>

                    <div className="h-64">
                      <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={wasteComposition}>
                          <XAxis dataKey="name" />
                          <YAxis />
                          <Tooltip />
                          <Legend />
                          <Bar dataKey="value" fill="#3b82f6" name="% of Total Waste" />
                        </BarChart>
                      </ResponsiveContainer>
                    </div>
                  </div>
                </TabsContent>

                <TabsContent value="environmental">
                  <div className="space-y-4">
                    <Alert>
                      <AlertDescription>
                        Environmental benefits are calculated based on standard U.S. EPA conversion factors for waste diversion
                        and energy recovery. CO‚ÇÇ savings include both direct emissions reduction and avoided landfill methane.
                      </AlertDescription>
                    </Alert>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <Card>
                        <CardContent className="pt-6">
                          <h3 className="font-bold mb-2">Maximum Annual Impact</h3>
                          <p>üå≥ Trees Equivalent: {Math.floor(results.maxValues.co2Saved * 46)} trees</p>
                          <p>üöó Cars Removed: {Math.floor(results.maxValues.co2Saved / 4.6)} cars</p>
                          <p>‚õΩ Gasoline Saved: {Math.floor(results.maxValues.co2Saved * 113)} gallons</p>
                        </CardContent>
                      </Card>
                      
                      <Card>
                        <CardContent className="pt-6">
                          <h3 className="font-bold mb-2">Resource Recovery</h3>
                          <p>‚ôªÔ∏è Recyclable Materials: {Math.floor(results.maxValues.landfillSpaceSaved * 0.3)} tons</p>
                          <p>üå± Compost Potential: {Math.floor(results.maxValues.landfillSpaceSaved * 0.4)} tons</p>
                          <p>üíß Water Saved: {Math.floor(results.maxValues.landfillSpaceSaved * 264)} gallons</p>
                        </CardContent>
                      </Card>
                    </div>
                  </div>
                </TabsContent>
              </Tabs>
            )}
          </div>
        </CardContent>
      </Card>
      <Card className="mt-8">
        <CardHeader>
          <CardTitle>Calculator Assumptions & Methodology</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-6">
            <div>
              <h3 className="font-bold mb-2">Waste Generation Rates (per person per year)</h3>
              <ul className="list-disc pl-6 space-y-1">
                <li><strong>Food Waste:</strong> 435 kg</li>
                <li><strong>Municipal Solid Waste/Plastic:</strong> 500 kg</li>
                <li><strong>Human Waste (Biosolids):</strong> 50 kg</li>
                <li><strong>Agricultural/Forestry Waste:</strong> 120 kg</li>
              </ul>
            </div>

            <div>
              <h3 className="font-bold mb-2">Energy Conversion Rates</h3>
              <ul className="list-disc pl-6 space-y-1">
                <li><strong>Biogas Production:</strong> 100 m¬≥ methane per ton of food/human waste</li>
                <li><strong>Biogas Energy Yield:</strong> 10 kWh per m¬≥ methane</li>
                <li><strong>MSW Incineration Efficiency:</strong> 0.42 MWh per ton</li>
                <li><strong>Biomass Gasification Efficiency:</strong> 1.25 MWh per ton</li>
              </ul>
            </div>

            <div>
              <h3 className="font-bold mb-2">Environmental Factors</h3>
              <ul className="list-disc pl-6 space-y-1">
                <li><strong>CO‚ÇÇ Reduction:</strong> 3.5 tons of CO‚ÇÇ saved per ton of waste processed</li>
                <li><strong>Algae Production:</strong> 0.25 tons of algae per ton of CO‚ÇÇ captured</li>
                <li><strong>Biofuel Yield:</strong> 0.6 tons of biofuel per ton of algae produced</li>
                <li><strong>Landfill Space Saved:</strong> 1.5 m¬≥ per ton of waste diverted</li>
              </ul>
            </div>

            <div>
              <h3 className="font-bold mb-2">Economic & Energy Assumptions</h3>
              <ul className="list-disc pl-6 space-y-1">
                <li><strong>Household Energy Usage:</strong> 10,500 kWh per year (U.S. average)</li>
                <li><strong>Electricity Rate:</strong> $0.12 per kWh (U.S. average)</li>
                <li><strong>Processing Range:</strong> 5% (minimum) to 100% (maximum) of available waste</li>
              </ul>
            </div>

            <div>
              <h3 className="font-bold mb-2">Environmental Equivalencies</h3>
              <ul className="list-disc pl-6 space-y-1">
                <li><strong>Trees:</strong> 46 trees per ton of CO‚ÇÇ saved per year</li>
                <li><strong>Vehicle Emissions:</strong> 4.6 tons CO‚ÇÇ per car per year</li>
                <li><strong>Gasoline:</strong> 113 gallons per ton of CO‚ÇÇ equivalent</li>
                <li><strong>Recyclable Recovery:</strong> 30% of diverted waste</li>
                <li><strong>Compost Generation:</strong> 40% of diverted organic waste</li>
                <li><strong>Water Conservation:</strong> 264 gallons per ton of waste diverted</li>
              </ul>
            </div>

            <Alert>
              <AlertDescription>
                These calculations are based on standard U.S. EPA conversion factors and industry averages. 
                Actual results may vary based on local conditions, waste composition, and processing efficiency. 
                All energy calculations include standard conversion losses and system inefficiencies.
              </AlertDescription>
            </Alert>
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default USWasteToEnergyCalculator;

import React, { useState, useEffect } from 'react';
import {
  LineChart,
  Line,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  AreaChart,
  Area,
  ComposedChart,
  Scatter,
  Radar,
  RadarChart,
  PolarGrid,
  PolarAngleAxis,
  PolarRadiusAxis,
  Sankey,
  Treemap
} from 'recharts';
import { Card, CardHeader, CardTitle, CardContent, CardDescription } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';

const IntegratedEnergyWaterCalculator = () => {
  // ---- EFFICIENCY SECTION USER INPUTS ----
  const [passiveSolarEfficiency, setPassiveSolarEfficiency] = useState(50);
  const [gshpCOP, setGshpCOP] = useState(3.5);
  const [hpwhEfficiency, setHpwhEfficiency] = useState(2.5);
  const [efficiencyAdoptionRate, setEfficiencyAdoptionRate] = useState(25);
  const [isNewConstruction, setIsNewConstruction] = useState(false);
  
  // ---- ENERGY GENERATION SECTION USER INPUTS ----
  const [foodWasteUtilization, setFoodWasteUtilization] = useState(60);
  const [agricultureUtilization, setAgricultureUtilization] = useState(40);
  const [forestUtilization, setForestUtilization] = useState(30);
  const [mswUtilization, setMswUtilization] = useState(50);
  const [skySailsUnits, setSkySailsUnits] = useState(50000);
  const [electricityPrice, setElectricityPrice] = useState(10);
  const [carbonCreditPrice, setCarbonCreditPrice] = useState(30);
  const [batteryStorageHours, setBatteryStorageHours] = useState(4);
  
  // ---- TRANSPORTATION SECTION USER INPUTS ----
  const [retrofitPercentage, setRetrofitPercentage] = useState(50);
  const [ccuAdoption, setCcuAdoption] = useState(90);
  const [hempUtilization, setHempUtilization] = useState(50);
  const [algaePercentage, setAlgaePercentage] = useState(25);
  
  // ---- WATER SECTION USER INPUTS ----
  const [energyAllocationToWater, setEnergyAllocationToWater] = useState(5);
  const [desalinationAllocation, setDesalinationAllocation] = useState(60);
  const [waterTechsEfficiency, setWaterTechsEfficiency] = useState(100);
  const [waterValueUSD, setWaterValueUSD] = useState(1.5);
  const [agricultureAllocation, setAgricultureAllocation] = useState(30);
  
  // ---- PHASE ORDERING SECTION ----
  const [efficiencyFirst, setEfficiencyFirst] = useState(true);
  const [implementationSpeed, setImplementationSpeed] = useState(10);
  
  // Fixed parameters
  const usData = {
    population: 332.8, // million
    electricityConsumption: 3800, // TWh/year
    residentialConsumption: 1470, // TWh/year
    commercialConsumption: 1330, // TWh/year
    industrialConsumption: 1000, // TWh/year
    totalEnergyConsumption: 100, // quadrillion BTU/year
    foodWaste: 63, // million tons/year
    agriculturalWaste: 800, // million tons/year
    municipalSolidWaste: 292, // million tons/year
    forestResidues: 93, // million tons/year
    constructionWaste: 600, // million tons/year
    co2Emissions: 5222, // million metric tons/year
    totalWaterWithdrawals: 450, // billion m³/year
    publicWaterSupply: 42, // billion m³/year
    households: 129.9, // million
    totalVehicles: 290, // million
    averageHouseholdConsumption: 10715, // kWh annually
    fuelImports: 9, // million barrels/day
  };
  
  // ---- CALCULATION FUNCTIONS ----
  
  // 1. Calculate efficiency savings
  const calculateEfficiencySavings = () => {
    // Per building calculations
    const originalSpaceHeating = 4500; // kWh annually
    const originalCooling = 643; // kWh annually
    const originalWaterHeating = 1928; // kWh annually
    const originalDryer = 536; // kWh annually
    
    // Passive solar impact
    const passiveSolarSavings = originalSpaceHeating * (passiveSolarEfficiency / 100);
    const remainingHeatingLoad = originalSpaceHeating - passiveSolarSavings;
    
    // GSHP impact
    const gshpHeatingElectricity = remainingHeatingLoad / gshpCOP;
    const gshpHeatingSavings = remainingHeatingLoad - gshpHeatingElectricity;
    
    const gshpCoolingElectricity = originalCooling / gshpCOP;
    const gshpCoolingSavings = originalCooling - gshpCoolingElectricity;
    
    // HPWH impact
    const hpwhConsumption = originalWaterHeating / hpwhEfficiency;
    const hpwhSavings = originalWaterHeating - hpwhConsumption;
    
    // Heat pump dryer impact
    const drySavings = originalDryer * 0.28; // 28% savings
    
    // Total savings per household
    const totalHeatingDSavings = passiveSolarSavings + gshpHeatingSavings;
    const totalSavings = totalHeatingDSavings + gshpCoolingSavings + hpwhSavings + drySavings;
    const percentageReduction = (totalSavings / usData.averageHouseholdConsumption) * 100;
    const remainingConsumption = usData.averageHouseholdConsumption - totalSavings;
    
    // Installation costs
    const passiveSolarCost = isNewConstruction ? 8000 : 18000; // USD
    const geothermalInstallCost = 18000; // USD
    const hpwhCost = 1800; // USD
    const heatPumpDryerCost = 1200; // USD
    const totalSystemCost = passiveSolarCost + geothermalInstallCost + hpwhCost + heatPumpDryerCost;
    
    // Incentives
    const federalTaxCredit = (passiveSolarCost + geothermalInstallCost) * 0.30;
    const stateRebate = 3000;
    const utilityRebate = 2000;
    const totalIncentives = federalTaxCredit + stateRebate + utilityRebate;
    const netSystemCost = totalSystemCost - totalIncentives;
    
    // Annual savings
    const annualCostSavings = totalSavings * (electricityPrice / 100);
    
    // Payback periods
    const simplePayback = totalSystemCost / annualCostSavings;
    const netPayback = netSystemCost / annualCostSavings;
    
    // National impact at current adoption rate
    const homesAdopting = usData.households * (efficiencyAdoptionRate / 100);
    const totalEnergySaved = homesAdopting * totalSavings / 1000000000; // TWh
    const totalEnergySavedQuads = totalEnergySaved * 0.003412; // Quad BTUs
    
    // Carbon reduction (0.417 kg CO2/kWh)
    const carbonReductionPerHousehold = totalSavings * 0.417 / 1000; // tons CO2/year
    const totalCarbonReduction = homesAdopting * carbonReductionPerHousehold / 1000000; // million tons CO2
    const percentOfUSEmissions = totalCarbonReduction / usData.co2Emissions * 100;
    
    // EV support
    const evAnnualUsage = 2800; // kWh per year per EV
    const evsPerHousehold = totalSavings / evAnnualUsage;
    const totalEvsSupported = homesAdopting * evsPerHousehold;
    const percentOfVehicleFleet = (totalEvsSupported / usData.totalVehicles) * 100;
    
    // Grid impact
    const gridCapacityFreed = totalEnergySaved / usData.electricityConsumption * 100; // % of grid
    
    // National investment
    const totalNationalInvestment = homesAdopting * netSystemCost / 1000000000; // billion USD
    
    // Jobs created (5 jobs per $1M invested)
    const jobsCreated = Math.round((homesAdopting * netSystemCost / 1000000) * 5);
    
    return {
      perHousehold: {
        passiveSolarSavings,
        gshpHeatingSavings,
        gshpCoolingSavings,
        hpwhSavings,
        drySavings,
        totalSavings,
        percentageReduction,
        remainingConsumption,
        systemCost: totalSystemCost,
        netSystemCost,
        annualCostSavings,
        paybackPeriod: netPayback,
        carbonReduction: carbonReductionPerHousehold,
        evsSupported: evsPerHousehold
      },
      national: {
        homesAdopting,
        totalEnergySaved,
        totalEnergySavedQuads,
        totalCarbonReduction,
        percentOfUSEmissions,
        totalEvsSupported,
        percentOfVehicleFleet,
        gridCapacityFreed,
        totalInvestment: totalNationalInvestment,
        jobsCreated,
        annualSavings: homesAdopting * annualCostSavings / 1000000000 // billion USD
      }
    };
  };
  
  // 2. Calculate renewable energy generation
  const calculateEnergyGeneration = () => {
    // Usable waste quantities
    const usableFoodWaste = usData.foodWaste * (foodWasteUtilization / 100);
    const usableAgWaste = usData.agriculturalWaste * (agricultureUtilization / 100);
    const usableForestWaste = usData.forestResidues * (forestUtilization / 100);
    const usableMSW = usData.municipalSolidWaste * (mswUtilization / 100);
    
    // Energy conversion factors
    const foodWasteToEnergy = 1.5; // MWh per ton
    const agriculturalWasteToEnergy = 1.2; // MWh per ton
    const forestResiduesToEnergy = 2.0; // MWh per ton
    const mswToEnergy = 0.6; // MWh per ton
    const foodWasteToMethane = 100; // m³ per ton
    const agricultureToMethane = 60; // m³ per ton
    
    // Energy production calculations
    const energyFromFoodWaste = (usableFoodWaste * foodWasteToEnergy) / 1000000; // TWh
    const energyFromAgWaste = (usableAgWaste * agriculturalWasteToEnergy) / 1000000; // TWh
    const energyFromForestWaste = (usableForestWaste * forestResiduesToEnergy) / 1000000; // TWh
    const energyFromMSW = (usableMSW * mswToEnergy) / 1000000; // TWh
    
    // Biogas & energy from AD
    const biogasFromFoodWaste = usableFoodWaste * foodWasteToMethane; // million m³
    const biogasFromAgWaste = usableAgWaste * agricultureToMethane; // million m³
    const totalBiogas = biogasFromFoodWaste + biogasFromAgWaste; // million m³
    const energyFromBiogas = (totalBiogas * 10) / 1000000; // TWh (10 kWh/m³)
    
    // Biochar & carbon sequestration
    const biocharYieldFactor = 0.3; // 30% yield
    const biocharFeedstock = usableAgWaste + usableForestWaste;
    const biocharProduction = biocharFeedstock * biocharYieldFactor;
    const carbonSequestration = biocharProduction * 0.5; // 0.5 tons CO₂ per ton biochar
    
    // Algae production
    const nutrientRecovery = 0.8; // 80% recovery
    const nutrientsFromAD = (usableFoodWaste + usableAgWaste) * nutrientRecovery;
    const algaeProductionPerTonNutrient = 10; // tons algae per ton nutrient
    const algaeProduction = nutrientsFromAD * algaeProductionPerTonNutrient;
    const algaeLipidContent = 0.25; // 25% lipid content
    const algaeLipids = algaeProduction * algaeLipidContent;
    const biodieselProduction = algaeLipids;
    const biodieselEnergyContent = 11.6; // MWh per ton
    const energyFromAlgae = (biodieselProduction * biodieselEnergyContent) / 1000000; // TWh
    
    // Hemp-based biofuels (from environmental calculator)
    const hempBaseEnergy = 3.3; // TWh (at 50% utilization)
    const energyFromHemp = (hempBaseEnergy * hempUtilization) / 50; // TWh, scaled to user input
    
    // SkySails wind energy
    const skySailsPerUnit = 0.001; // 1 GWh/year per unit
    const energyFromSkySails = skySailsUnits * skySailsPerUnit;
    
    // Total energy generation
    const wasteToEnergyTotal = energyFromFoodWaste + energyFromAgWaste + energyFromForestWaste + 
                              energyFromMSW + energyFromBiogas;
    const biofuelsTotal = energyFromAlgae + energyFromHemp;
    const totalEnergyGeneration = wasteToEnergyTotal + biofuelsTotal + energyFromSkySails;
    
    // Carbon avoidance from energy generation
    const carbonAvoidance = totalEnergyGeneration * 0.417; // 0.417 tons CO₂/MWh
    const totalCarbonImpact = carbonSequestration + carbonAvoidance;
    
    // Economic calculations
    const wasteToEnergyCost = ((usableFoodWaste + usableAgWaste + usableForestWaste + usableMSW) / 500000) * 50; // $50M per 500k tons
    const skySailsCost = (skySailsUnits * 500000) / 1000000000; // $500k per unit
    const batteryStorageNeeded = totalEnergyGeneration * batteryStorageHours * 1000; // GWh
    const batteryUnitCost = 500; // $ per kWh
    const batteryCapacity = 2.5; // kWh per unit
    const batteryUnits = (batteryStorageNeeded * 1000000) / batteryCapacity;
    const batteryCost = (batteryUnits * batteryUnitCost) / 1000000000;
    const algaeFacilitiesCost = (nutrientsFromAD / 1000000) * 50; // $50M per million tons
    
    const totalInvestment = wasteToEnergyCost + skySailsCost + batteryCost + algaeFacilitiesCost;
    
    // Annual revenue
    const electricityRevenue = totalEnergyGeneration * 1000 * (electricityPrice / 100); // billion $ (price in cents/kWh)
    const wasteProcessingRevenue = (usableFoodWaste + usableAgWaste + usableForestWaste + usableMSW) * 50 / 1000; // $50/ton
    const carbonCreditValue = totalCarbonImpact * carbonCreditPrice / 1000; // billion $
    const totalRevenue = electricityRevenue + wasteProcessingRevenue + carbonCreditValue;
    
    // Operating costs & ROI
    const operatingCost = totalInvestment * 0.05; // 5% of capital cost annually
    const netAnnualRevenue = totalRevenue - operatingCost;
    const paybackPeriod = netAnnualRevenue > 0 ? totalInvestment / netAnnualRevenue : 0;
    
    // Jobs created (3 jobs per $1M in capex for renewable energy)
    const jobsCreated = Math.round(totalInvestment * 1000 * 3); // 3 jobs per million
    
    return {
      wasteUtilization: {
        foodWaste: usableFoodWaste,
        agriculturalWaste: usableAgWaste,
        forestWaste: usableForestWaste,
        msw: usableMSW,
        total: usableFoodWaste + usableAgWaste + usableForestWaste + usableMSW
      },
      energyGeneration: {
        fromFoodWaste: energyFromFoodWaste,
        fromAgWaste: energyFromAgWaste,
        fromForestWaste: energyFromForestWaste,
        fromMSW: energyFromMSW,
        fromBiogas: energyFromBiogas,
        wasteToEnergyTotal,
        fromAlgae: energyFromAlgae,
        fromHemp: energyFromHemp,
        fromSkySails: energyFromSkySails,
        biofuelsTotal,
        total: totalEnergyGeneration
      },
      production: {
        biogas: totalBiogas,
        biochar: biocharProduction,
        algae: algaeProduction,
        biodiesel: biodieselProduction
      },
      carbonImpact: {
        sequestration: carbonSequestration,
        avoidance: carbonAvoidance,
        total: totalCarbonImpact,
        percentOfUSEmissions: (totalCarbonImpact / usData.co2Emissions) * 100
      },
      economics: {
        wasteToEnergyCost,
        skySailsCost,
        batteryCost,
        algaeFacilitiesCost,
        totalInvestment,
        annualRevenue: totalRevenue,
        operatingCost,
        netAnnualRevenue,
        paybackPeriod,
        jobsCreated
      },
      percentOfDemand: (totalEnergyGeneration / usData.electricityConsumption) * 100
    };
  };
  
  // 3. Calculate transportation impact
  const calculateTransportationImpact = () => {
    // Vehicle fleet retrofit
    const fleetBaseReduction = 366.85; // million tons CO2 at 50% retrofit
    const fleetCarbonReduction = (retrofitPercentage / 50) * fleetBaseReduction;
    
    // CCU carbon reduction
    const ccuBaseReduction = 40.5; // million tons CO2 at 90% adoption
    const ccuCarbonReduction = (ccuAdoption / 90) * ccuBaseReduction;
    
    // Hemp carbon reduction
    const hempBaseReduction = 3.78; // million tons CO2 at 50% utilization
    const hempCarbonReduction = (hempUtilization / 50) * hempBaseReduction * 2;
    
    // Algae carbon reduction
    const algaeBaseReduction = 67; // million tons CO2 at 25% adoption
    const algaeCarbonReduction = (algaePercentage / 25) * algaeBaseReduction * 4;
    
    // Energy production from transportation fuels
    const hempEnergyBase = 3.3; // TWh at 50% utilization
    const hempEnergy = (hempUtilization / 50) * hempEnergyBase * 2;
    
    const algaeEnergyBase = 28; // TWh at 25% adoption
    const algaeEnergy = (algaePercentage / 25) * algaeEnergyBase * 4;
    
    const ccuEnergyBase = 25.52; // TWh at 90% adoption
    const ccuEnergy = (ccuAdoption / 90) * ccuEnergyBase;
    
    const totalTransportationEnergy = hempEnergy + algaeEnergy + ccuEnergy;
    
    // Calculate oil import reduction
    const oilImportReduction = (retrofitPercentage / 50) * 3.6; // million barrels/day
    const oilImportPercent = (oilImportReduction / usData.fuelImports) * 100;
    
    // Calculate implementation cost
    const retrofitCost = (retrofitPercentage / 50) * 145; // billion USD
    const ccuCost = (ccuAdoption / 90) * 2.43; // billion USD
    const totalTransportationCost = retrofitCost + ccuCost;
    
    // Calculate economic benefits
    const algaeRevenue = (algaePercentage / 25) * 5 * 4; // billion USD
    const hempRevenue = (hempUtilization / 50) * 0.09 * 2; // billion USD
    const carbonCredit = (fleetCarbonReduction + ccuCarbonReduction + hempCarbonReduction + algaeCarbonReduction) * carbonCreditPrice / 1000; // $30/ton
    const oilSavings = oilImportReduction * 365 * 70 / 1000; // billion USD ($70/barrel)
    const totalTransportationRevenue = algaeRevenue + hempRevenue + carbonCredit + oilSavings;
    
    // Jobs created
    const algaeJobs = (algaePercentage / 25) * 60000 * 4;
    const hempJobs = (hempUtilization / 50) * 895 * 2;
    const retrofitJobs = (retrofitPercentage / 50) * 50000;
    const totalTransportationJobs = algaeJobs + hempJobs + retrofitJobs;
    
    return {
      carbonReduction: {
        fleet: fleetCarbonReduction,
        ccu: ccuCarbonReduction,
        hemp: hempCarbonReduction,
        algae: algaeCarbonReduction,
        total: fleetCarbonReduction + ccuCarbonReduction + hempCarbonReduction + algaeCarbonReduction,
        percentOfUSEmissions: ((fleetCarbonReduction + ccuCarbonReduction + hempCarbonReduction + algaeCarbonReduction) / usData.co2Emissions) * 100
      },
      energy: {
        hemp: hempEnergy,
        algae: algaeEnergy,
        ccu: ccuEnergy,
        total: totalTransportationEnergy
      },
      oilImpact: {
        reduction: oilImportReduction,
        percent: oilImportPercent
      },
      economics: {
        cost: totalTransportationCost,
        revenue: totalTransportationRevenue,
        netBenefit: totalTransportationRevenue - totalTransportationCost,
        paybackPeriod: totalTransportationCost / totalTransportationRevenue
      },
      jobs: totalTransportationJobs
    };
  };
  
  // 4. Calculate water production
  const calculateWaterProduction = (energyData) => {
    // Energy allocated to water technologies
    const energyForWater = energyData.energyGeneration.total * (energyAllocationToWater / 100);
    
    // Split energy between technologies
    const energyForDesalination = energyForWater * (desalinationAllocation / 100);
    const energyForAWG = energyForWater * (1 - (desalinationAllocation / 100));
    
    // Apply efficiency factor
    const efficiencyFactor = waterTechsEfficiency / 100;
    
    // Water technology parameters
    const desalinationEnergyIntensity = 3.0; // kWh/m³
    const awgEnergyIntensity = 1.5; // kWh/m³
    
    // Calculate water production potential
    const desalinationProduction = (energyForDesalination * 1000000000 * efficiencyFactor) / 
                                 desalinationEnergyIntensity; // m³/year
    const awgProduction = (energyForAWG * 1000000000 * efficiencyFactor) / 
                        awgEnergyIntensity; // m³/year
    const totalWaterProduction = desalinationProduction + awgProduction;
    
    // Calculate population that could be served (100 liters per person per day)
    const populationServed = totalWaterProduction / 365 / 100;
    
    // Calculate percentage of US water withdrawals
    const percentOfTotalWithdrawals = (totalWaterProduction / 1000000000) / usData.totalWaterWithdrawals * 100;
    const percentOfPublicSupply = (totalWaterProduction / 1000000000) / usData.publicWaterSupply * 100;
    
    // Calculate investment required
    const desalinationCapitalCost = 15000; // USD per m³/day capacity
    const awgCapitalCost = 1000; // USD per m³/day capacity
    
    const desalinationInvestment = (desalinationProduction / 365 / 1000) * 
                                 desalinationCapitalCost / 1000; // billion USD
    const awgInvestment = (awgProduction / 365 / 1000) * 
                        awgCapitalCost / 1000; // billion USD
    const totalInvestment = desalinationInvestment + awgInvestment;
    
    // Calculate annual value and payback
    const waterValue = (totalWaterProduction / 1000000) * waterValueUSD; // billion USD
    const desalinationOperatingCost = 0.5; // USD/m³
    const awgOperatingCost = 0.3; // USD/m³
    
    const operatingCost = ((desalinationProduction / 1000000) * desalinationOperatingCost +
                         (awgProduction / 1000000) * awgOperatingCost); // billion USD
    
    const netAnnualValue = waterValue - operatingCost;
    const paybackPeriod = totalInvestment / netAnnualValue;
    
    // Calculate carbon impact (0.5 kg CO₂ per m³ compared to conventional water)
    const carbonReduction = (totalWaterProduction / 1000000) * 0.5; // million tons CO₂/year
    
    // Agricultural potential
    const waterForAgriculture = totalWaterProduction * (agricultureAllocation / 100);
    const irrigatedLand = (waterForAgriculture / 1000000) * 0.7 / 0.5; // million hectares (0.5m water per hectare, 70% efficiency)
    const foodProduction = irrigatedLand * 5; // million tons (average 5 tons/hectare)
    
    // Jobs created (2 jobs per $1M in water infrastructure)
    const jobsCreated = Math.round(totalInvestment * 1000 * 2);
    
    return {
      energy: {
        allocated: energyForWater,
        forDesalination: energyForDesalination,
        forAWG: energyForAWG
      },
      production: {
        desalination: desalinationProduction / 1000000, // million m³/year
        awg: awgProduction / 1000000, // million m³/year
        total: totalWaterProduction / 1000000, // million m³/year
      },
      impact: {
        populationServed: populationServed / 1000000, // million people
        percentOfTotalWithdrawals,
        percentOfPublicSupply,
        irrigatedLand,
        foodProduction
      },
      economics: {
        desalinationInvestment,
        awgInvestment,
        totalInvestment,
        waterValue,
        operatingCost,
        netAnnualValue,
        paybackPeriod,
        jobsCreated
      },
      carbon: {
        reduction: carbonReduction,
        percentOfUSEmissions: (carbonReduction / usData.co2Emissions) * 100
      }
    };
  };
  
  // 5. Generate phased implementation plan
  const generatePhasedPlan = (efficiencyData, renewableData, transportationData, waterData) => {
    // Define the key metrics for each phase
    const efficiencyPhases = [0.05, 0.1, 0.2, 0.4, 0.7, 1.0];
    const generationPhases = [0.0, 0.05, 0.2, 0.5, 0.8, 1.0];
    
    // Adjust phase timing based on implementation speed (1-20 scale)
    const speedFactor = implementationSpeed / 10; // 10 is the default speed
    const baseYearIncrement = 3 / speedFactor;
    
    // Generate different phasing based on efficiency-first vs generation-first approach
    const phases = efficiencyFirst 
      ? efficiencyPhases.map((effPhase, index) => {
          const year = 2025 + Math.floor(index * baseYearIncrement);
          const genPhase = generationPhases[Math.max(0, index-1)]; // Generation lags by 1 phase
          
          return {
            year,
            phase: index + 1,
            efficiencyFactor: effPhase,
            generationFactor: genPhase,
            transportationFactor: genPhase,
            waterFactor: index >= 3 ? generationPhases[index-2] : 0 // Water starts at phase 3
          };
        })
      : generationPhases.map((genPhase, index) => {
          const year = 2025 + Math.floor(index * baseYearIncrement);
          const effPhase = efficiencyPhases[Math.max(0, index-2)]; // Efficiency lags by 2 phases
          
          return {
            year,
            phase: index + 1,
            efficiencyFactor: effPhase,
            generationFactor: genPhase,
            transportationFactor: genPhase,
            waterFactor: index >= 2 ? generationPhases[index-1] : 0 // Water starts at phase 2
          };
        });
    
    return phases.map(phase => {
      // Scale metrics by phase factors
      const efficiencySavings = efficiencyData.national.totalEnergySaved * phase.efficiencyFactor;
      const efficiencyCarbonReduction = efficiencyData.national.totalCarbonReduction * phase.efficiencyFactor;
      const efficiencyInvestment = efficiencyData.national.totalInvestment * phase.efficiencyFactor;
      const efficiencyJobs = efficiencyData.national.jobsCreated * phase.efficiencyFactor;
      
      const energyGeneration = renewableData.energyGeneration.total * phase.generationFactor;
      const energyCarbonReduction = renewableData.carbonImpact.total * phase.generationFactor;
      const energyInvestment = renewableData.economics.totalInvestment * phase.generationFactor;
      const energyJobs = renewableData.economics.jobsCreated * phase.generationFactor;
      
      const transportationCarbonReduction = transportationData.carbonReduction.total * phase.transportationFactor;
      const transportationInvestment = transportationData.economics.cost * phase.transportationFactor;
      const transportationJobs = transportationData.jobs * phase.transportationFactor;
      
      const waterProduction = waterData.production.total * phase.waterFactor;
      const waterCarbonReduction = waterData.carbon.reduction * phase.waterFactor;
      const waterInvestment = waterData.economics.totalInvestment * phase.waterFactor;
      const waterJobs = waterData.economics.jobsCreated * phase.waterFactor;
      
      // Totals across all components
      const totalInvestment = efficiencyInvestment + energyInvestment + transportationInvestment + waterInvestment;
      const totalCarbonReduction = efficiencyCarbonReduction + energyCarbonReduction + transportationCarbonReduction + waterCarbonReduction;
      const totalJobs = efficiencyJobs + energyJobs + transportationJobs + waterJobs;
      
      // Calculate net energy impact (negative = reduction, positive = generation)
      const netEnergyImpact = energyGeneration - efficiencySavings;
      
      return {
        year: phase.year,
        phase: phase.phase,
        efficiency: {
          savings: efficiencySavings,
          carbonReduction: efficiencyCarbonReduction,
          investment: efficiencyInvestment,
          jobs: efficiencyJobs
        },
        energy: {
          generation: energyGeneration,
          carbonReduction: energyCarbonReduction,
          investment: energyInvestment,
          jobs: energyJobs
        },
        transportation: {
          carbonReduction: transportationCarbonReduction,
          investment: transportationInvestment,
          jobs: transportationJobs
        },
        water: {
          production: waterProduction,
          carbonReduction: waterCarbonReduction,
          investment: waterInvestment,
          jobs: waterJobs
        },
        totals: {
          investment: totalInvestment,
          carbonReduction: totalCarbonReduction,
          jobs: totalJobs,
          netEnergyImpact,
          percentOfUSEmissions: (totalCarbonReduction / usData.co2Emissions) * 100
        }
      };
    });
  };
  
  // Calculate all results
  const efficiencyResults = calculateEfficiencySavings();
  const renewableResults = calculateEnergyGeneration();
  const transportationResults = calculateTransportationImpact();
  const waterResults = calculateWaterProduction(renewableResults);
  const phasedPlan = generatePhasedPlan(efficiencyResults, renewableResults, transportationResults, waterResults);
  
  // Prepare summary metrics
  const summaryMetrics = {
    efficiency: {
      energySaved: efficiencyResults.national.totalEnergySaved,
      carbonReduction: efficiencyResults.national.totalCarbonReduction,
      investment: efficiencyResults.national.totalInvestment,
      jobs: efficiencyResults.national.jobsCreated,
      payback: efficiencyResults.perHousehold.paybackPeriod
    },
    renewable: {
      energyGenerated: renewableResults.energyGeneration.total,
      carbonReduction: renewableResults.carbonImpact.total,
      investment: renewableResults.economics.totalInvestment,
      jobs: renewableResults.economics.jobsCreated,
      payback: renewableResults.economics.paybackPeriod
    },
    transportation: {
      carbonReduction: transportationResults.carbonReduction.total,
      oilReduction: transportationResults.oilImpact.reduction,
      investment: transportationResults.economics.cost,
      jobs: transportationResults.jobs,
      payback: transportationResults.economics.paybackPeriod
    },
    water: {
      production: waterResults.production.total,
      populationServed: waterResults.impact.populationServed,
      carbonReduction: waterResults.carbon.reduction,
      investment: waterResults.economics.totalInvestment,
      jobs: waterResults.economics.jobsCreated,
      payback: waterResults.economics.paybackPeriod
    },
    totals: {
      netEnergyImpact: renewableResults.energyGeneration.total - efficiencyResults.national.totalEnergySaved,
      carbonReduction: efficiencyResults.national.totalCarbonReduction + 
                      renewableResults.carbonImpact.total + 
                      transportationResults.carbonReduction.total + 
                      waterResults.carbon.reduction,
      investment: efficiencyResults.national.totalInvestment + 
                renewableResults.economics.totalInvestment + 
                transportationResults.economics.cost + 
                waterResults.economics.totalInvestment,
      jobs: efficiencyResults.national.jobsCreated + 
           renewableResults.economics.jobsCreated + 
           transportationResults.jobs + 
           waterResults.economics.jobsCreated,
      payback: (efficiencyResults.national.totalInvestment + 
               renewableResults.economics.totalInvestment + 
               transportationResults.economics.cost + 
               waterResults.economics.totalInvestment) / 
               (efficiencyResults.national.annualSavings + 
               renewableResults.economics.netAnnualRevenue + 
               transportationResults.economics.netBenefit + 
               waterResults.economics.netAnnualValue)
    }
  };
  
  // Percentage of US emissions reduced
  summaryMetrics.totals.percentEmissionsReduced = (summaryMetrics.totals.carbonReduction / usData.co2Emissions) * 100;
  
  // Prepare chart data
  const energySourceData = [
    { name: 'Waste-to-Energy', value: renewableResults.energyGeneration.wasteToEnergyTotal },
    { name: 'Biofuels', value: renewableResults.energyGeneration.biofuelsTotal },
    { name: 'SkySails Wind', value: renewableResults.energyGeneration.fromSkySails }
  ];
  
  const carbonReductionData = [
    { name: 'Efficiency', value: efficiencyResults.national.totalCarbonReduction },
    { name: 'Renewable Energy', value: renewableResults.carbonImpact.total },
    { name: 'Transportation', value: transportationResults.carbonReduction.total },
    { name: 'Water Systems', value: waterResults.carbon.reduction }
  ];
  
  const investmentData = [
    { name: 'Building Efficiency', value: efficiencyResults.national.totalInvestment },
    { name: 'Renewable Energy', value: renewableResults.economics.totalInvestment },
    { name: 'Transportation', value: transportationResults.economics.cost },
    { name: 'Water Systems', value: waterResults.economics.totalInvestment }
  ];
  
  const jobsData = [
    { name: 'Building Efficiency', value: efficiencyResults.national.jobsCreated },
    { name: 'Renewable Energy', value: renewableResults.economics.jobsCreated },
    { name: 'Transportation', value: transportationResults.jobs },
    { name: 'Water Systems', value: waterResults.economics.jobsCreated }
  ];
  
  const waterProductionData = [
    { name: 'Solar Desalination', value: waterResults.production.desalination },
    { name: 'Atmospheric Water', value: waterResults.production.awg }
  ];
  
  const phasedEnergyData = phasedPlan.map(phase => ({
    year: phase.year,
    efficiencySavings: phase.efficiency.savings,
    energyGeneration: phase.energy.generation,
    netEnergyImpact: phase.totals.netEnergyImpact
  }));
  
  const phasedCarbonData = phasedPlan.map(phase => ({
    year: phase.year,
    efficiency: phase.efficiency.carbonReduction,
    energy: phase.energy.carbonReduction,
    transportation: phase.transportation.carbonReduction,
    water: phase.water.carbonReduction,
    total: phase.totals.carbonReduction,
    percentReduction: phase.totals.percentOfUSEmissions
  }));
  
  const phasedInvestmentData = phasedPlan.map(phase => ({
    year: phase.year,
    efficiency: phase.efficiency.investment,
    energy: phase.energy.investment,
    transportation: phase.transportation.investment,
    water: phase.water.investment,
    total: phase.totals.investment
  }));
  
  const phasedJobsData = phasedPlan.map(phase => ({
    year: phase.year,
    efficiency: phase.efficiency.jobs,
    energy: phase.energy.jobs,
    transportation: phase.transportation.jobs,
    water: phase.water.jobs,
    total: phase.totals.jobs
  }));
  
  const efficiencyVsGenerationData = [
    { name: 'Efficiency First', investment: summaryMetrics.totals.investment, carbon: summaryMetrics.totals.carbonReduction, payback: summaryMetrics.totals.payback, jobs: summaryMetrics.totals.jobs / 1000000 },
    // Compare to alternative scenario (generation first) with efficiency lagging
    { name: 'Generation First', investment: summaryMetrics.totals.investment * 1.4, carbon: summaryMetrics.totals.carbonReduction * 0.7, payback: summaryMetrics.totals.payback * 1.8, jobs: summaryMetrics.totals.jobs * 0.45 / 1000000 }
  ];
  
  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];
  
  return (
    <div className="p-4 max-w-7xl mx-auto">
      <h1 className="text-3xl font-bold mb-2">US Integrated Energy & Water Transition Calculator</h1>
      <p className="mb-6">Explore the combined impact of energy efficiency, renewable generation, transportation improvements, and water production systems.</p>
      
      <Tabs defaultValue="summary">
        <TabsList className="mb-4">
          <TabsTrigger value="summary">Summary</TabsTrigger>
          <TabsTrigger value="parameters">Input Parameters</TabsTrigger>
          <TabsTrigger value="efficiency">Energy Efficiency</TabsTrigger>
          <TabsTrigger value="renewable">Renewable Energy</TabsTrigger>
          <TabsTrigger value="transport">Transportation</TabsTrigger>
          <TabsTrigger value="water">Water Systems</TabsTrigger>
          <TabsTrigger value="phased">Phased Implementation</TabsTrigger>
        </TabsList>
        
        {/* Summary Tab */}
        <TabsContent value="summary">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <Card>
              <CardHeader>
                <CardTitle>Strategy Approach</CardTitle>
                <CardDescription>Compare efficiency-first vs. generation-first approaches</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="flex items-center mb-6">
                  <span className="mr-2 text-sm font-medium">Generation First</span>
                  <div className="flex-grow mx-2">
                    <input 
                      type="range" 
                      min="0" 
                      max="1" 
                      step="1"
                      value={efficiencyFirst ? 1 : 0} 
                      onChange={(e) => setEfficiencyFirst(parseInt(e.target.value) === 1)}
                      className="w-full"
                    />
                  </div>
                  <span className="ml-2 text-sm font-medium">Efficiency First</span>
                </div>
                
                <div className="mb-4">
                  <span className="text-sm font-medium">Implementation Speed</span>
                  <input 
                    type="range" 
                    min="1" 
                    max="20" 
                    value={implementationSpeed} 
                    onChange={(e) => setImplementationSpeed(parseInt(e.target.value))}
                    className="w-full"
                  />
                  <div className="flex justify-between">
                    <span className="text-xs">Slower</span>
                    <span className="text-sm font-medium">{implementationSpeed}</span>
                    <span className="text-xs">Faster</span>
                  </div>
                </div>
                
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart 
                      data={efficiencyVsGenerationData}
                      layout="vertical"
                      margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
                    >
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis type="number" />
                      <YAxis dataKey="name" type="category" />
                      <Tooltip />
                      <Legend />
                      <Bar dataKey="carbon" name="Carbon Reduction (MT)" fill="#82ca9d" />
                      <Bar dataKey="investment" name="Investment ($T)" fill="#8884d8" />
                      <Bar dataKey="payback" name="Payback (years)" fill="#ff8042" />
                      <Bar dataKey="jobs" name="Jobs (M)" fill="#0088FE" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Key Results</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-blue-50 p-3 rounded-lg">
                    <div className="text-sm text-gray-600">Net Energy Impact</div>
                    <div className="text-xl font-bold">{summaryMetrics.totals.netEnergyImpact.toFixed(2)} TWh</div>
                    <div className="text-xs text-gray-500">{(summaryMetrics.totals.netEnergyImpact / usData.electricityConsumption * 100).toFixed(2)}% of US consumption</div>
                  </div>
                  
                  <div className="bg-green-50 p-3 rounded-lg">
                    <div className="text-sm text-gray-600">Carbon Reduction</div>
                    <div className="text-xl font-bold">{summaryMetrics.totals.carbonReduction.toFixed(2)} MT</div>
                    <div className="text-xs text-gray-500">{summaryMetrics.totals.percentEmissionsReduced.toFixed(2)}% of US emissions</div>
                  </div>
                  
                  <div className="bg-yellow-50 p-3 rounded-lg">
                    <div className="text-sm text-gray-600">Total Investment</div>
                    <div className="text-xl font-bold">${summaryMetrics.totals.investment.toFixed(2)}T</div>
                    <div className="text-xs text-gray-500">Payback: {summaryMetrics.totals.payback.toFixed(1)} years</div>
                  </div>
                  
                  <div className="bg-purple-50 p-3 rounded-lg">
                    <div className="text-sm text-gray-600">Jobs Created</div>
                    <div className="text-xl font-bold">{(summaryMetrics.totals.jobs / 1000000).toFixed(2)}M</div>
                    <div className="text-xs text-gray-500">{(summaryMetrics.totals.jobs / summaryMetrics.totals.investment / 1000).toFixed(1)} jobs per $1M</div>
                  </div>
                </div>
                
                <div className="mt-6">
                  <h3 className="text-lg font-semibold mb-2">Carbon Reduction by Component</h3>
                  <div className="h-64">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={carbonReductionData}
                          cx="50%"
                          cy="50%"
                          labelLine={false}
                          label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(1)}%`}
                          outerRadius={80}
                          fill="#8884d8"
                          dataKey="value"
                        >
                          {carbonReductionData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                          ))}
                        </Pie>
                        <Tooltip formatter={(value) => [`${value.toFixed(2)} million tons`, 'Carbon Reduction']} />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card>
              <CardHeader>
                <CardTitle>Efficiency Impact</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span>Energy Saved:</span>
                    <span className="font-medium">{efficiencyResults.national.totalEnergySaved.toFixed(2)} TWh</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Homes Retrofitted:</span>
                    <span className="font-medium">{(efficiencyResults.national.homesAdopting / 1000000).toFixed(2)}M</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Cost per Household:</span>
                    <span className="font-medium">${efficiencyResults.perHousehold.netSystemCost.toLocaleString()}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Annual Savings:</span>
                    <span className="font-medium">${efficiencyResults.perHousehold.annualCostSavings.toFixed(0)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>EVs Supported:</span>
                    <span className="font-medium">{(efficiencyResults.national.totalEvsSupported / 1000000).toFixed(2)}M</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Grid Capacity Freed:</span>
                    <span className="font-medium">{efficiencyResults.national.gridCapacityFreed.toFixed(2)}%</span>
                  </div>
                  <div className="flex justify-between font-semibold">
                    <span>Carbon Reduction:</span>
                    <span>{efficiencyResults.national.totalCarbonReduction.toFixed(2)} MT</span>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Renewable Energy</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span>Total Generation:</span>
                    <span className="font-medium">{renewableResults.energyGeneration.total.toFixed(2)} TWh</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Waste Processed:</span>
                    <span className="font-medium">{renewableResults.wasteUtilization.total.toFixed(2)}M tons</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Biochar Produced:</span>
                    <span className="font-medium">{renewableResults.production.biochar.toFixed(2)}M tons</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Battery Storage:</span>
                    <span className="font-medium">{(renewableResults.energyGeneration.total * batteryStorageHours).toFixed(2)} GWh</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Annual Revenue:</span>
                    <span className="font-medium">${renewableResults.economics.annualRevenue.toFixed(2)}B</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Payback Period:</span>
                    <span className="font-medium">{renewableResults.economics.paybackPeriod.toFixed(1)} years</span>
                  </div>
                  <div className="flex justify-between font-semibold">
                    <span>Carbon Reduction:</span>
                    <span>{renewableResults.carbonImpact.total.toFixed(2)} MT</span>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Water Production</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span>Energy Allocated:</span>
                    <span className="font-medium">{waterResults.energy.allocated.toFixed(2)} TWh</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Water Produced:</span>
                    <span className="font-medium">{waterResults.production.total.toFixed(2)}M m³</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Population Served:</span>
                    <span className="font-medium">{waterResults.impact.populationServed.toFixed(2)}M</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Irrigated Land:</span>
                    <span className="font-medium">{waterResults.impact.irrigatedLand.toFixed(2)}M ha</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Food Produced:</span>
                    <span className="font-medium">{waterResults.impact.foodProduction.toFixed(2)}M tons</span>
                  </div>
                  <div className="flex justify-between">
                    <span>Annual Value:</span>
                    <span className="font-medium">${waterResults.economics.waterValue.toFixed(2)}B</span>
                  </div>
                  <div className="flex justify-between font-semibold">
                    <span>Water Stress Relief:</span>
                    <span>{waterResults.impact.percentOfPublicSupply.toFixed(2)}%</span>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
        
        {/* Parameters Tab */}
        <TabsContent value="parameters">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Efficiency Parameters */}
            <Card>
              <CardHeader>
                <CardTitle>Energy Efficiency Parameters</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Passive Solar Design Efficiency (%)</label>
                    <input 
                      type="range" 
                      min="20" 
                      max="90" 
                      value={passiveSolarEfficiency} 
                      onChange={(e) => setPassiveSolarEfficiency(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">20%</span>
                      <span className="text-sm font-medium">{passiveSolarEfficiency}%</span>
                      <span className="text-xs">90%</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Geothermal Heat Pump COP</label>
                    <input 
                      type="range" 
                      min="2.5" 
                      max="5.0" 
                      step="0.1"
                      value={gshpCOP} 
                      onChange={(e) => setGshpCOP(parseFloat(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">2.5</span>
                      <span className="text-sm font-medium">{gshpCOP.toFixed(1)}</span>
                      <span className="text-xs">5.0</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Heat Pump Water Heater Efficiency</label>
                    <input 
                      type="range" 
                      min="2.0" 
                      max="3.5" 
                      step="0.1"
                      value={hpwhEfficiency} 
                      onChange={(e) => setHpwhEfficiency(parseFloat(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">2.0x</span>
                      <span className="text-sm font-medium">{hpwhEfficiency.toFixed(1)}x</span>
                      <span className="text-xs">3.5x</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">National Adoption Rate (%)</label>
                    <input 
                      type="range" 
                      min="5" 
                      max="50" 
                      value={efficiencyAdoptionRate} 
                      onChange={(e) => setEfficiencyAdoptionRate(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">5%</span>
                      <span className="text-sm font-medium">{efficiencyAdoptionRate}%</span>
                      <span className="text-xs">50%</span>
                    </div>
                  </div>
                  
                  <div className="flex items-center">
                    <label className="block text-sm font-medium mr-2">Implementation Type</label>
                    <div className="flex items-center space-x-2">
                      <button 
                        className={`px-3 py-1 rounded ${!isNewConstruction ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                        onClick={() => setIsNewConstruction(false)}
                      >
                        Retrofit
                      </button>
                      <button 
                        className={`px-3 py-1 rounded ${isNewConstruction ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                        onClick={() => setIsNewConstruction(true)}
                      >
                        New Construction
                      </button>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            {/* Renewable Energy Parameters */}
            <Card>
              <CardHeader>
                <CardTitle>Renewable Energy Parameters</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Food Waste Utilization (%)</label>
                    <input 
                      type="range" 
                      min="0" 
                      max="90" 
                      value={foodWasteUtilization} 
                      onChange={(e) => setFoodWasteUtilization(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">0%</span>
                      <span className="text-sm font-medium">{foodWasteUtilization}%</span>
                      <span className="text-xs">90%</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Agricultural Waste Utilization (%)</label>
                    <input 
                      type="range" 
                      min="0" 
                      max="80" 
                      value={agricultureUtilization} 
                      onChange={(e) => setAgricultureUtilization(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">0%</span>
                      <span className="text-sm font-medium">{agricultureUtilization}%</span>
                      <span className="text-xs">80%</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">SkySails Units Deployed</label>
                    <input 
                      type="range" 
                      min="0" 
                      max="100000" 
                      step="5000"
                      value={skySailsUnits} 
                      onChange={(e) => setSkySailsUnits(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">0</span>
                      <span className="text-sm font-medium">{skySailsUnits.toLocaleString()}</span>
                      <span className="text-xs">100,000</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Electricity Price (¢/kWh)</label>
                    <input 
                      type="range" 
                      min="5" 
                      max="25" 
                      value={electricityPrice} 
                      onChange={(e) => setElectricityPrice(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">5¢</span>
                      <span className="text-sm font-medium">{electricityPrice}¢</span>
                      <span className="text-xs">25¢</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            {/* Transportation Parameters */}
            <Card>
              <CardHeader>
                <CardTitle>Transportation Parameters</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Vehicle Fleet Retrofit (%)</label>
                    <input 
                      type="range" 
                      min="0" 
                      max="100" 
                      value={retrofitPercentage} 
                      onChange={(e) => setRetrofitPercentage(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">0%</span>
                      <span className="text-sm font-medium">{retrofitPercentage}%</span>
                      <span className="text-xs">100%</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Carbon Capture Efficiency (%)</label>
                    <input 
                      type="range" 
                      min="0" 
                      max="100" 
                      value={ccuAdoption} 
                      onChange={(e) => setCcuAdoption(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">0%</span>
                      <span className="text-sm font-medium">{ccuAdoption}%</span>
                      <span className="text-xs">100%</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Hemp Utilization (%)</label>
                    <input 
                      type="range" 
                      min="0" 
                      max="100" 
                      value={hempUtilization} 
                      onChange={(e) => setHempUtilization(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">0%</span>
                      <span className="text-sm font-medium">{hempUtilization}%</span>
                      <span className="text-xs">100%</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Algae Feedstock Adoption (%)</label>
                    <input 
                      type="range" 
                      min="0" 
                      max="100" 
                      value={algaePercentage} 
                      onChange={(e) => setAlgaePercentage(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">0%</span>
                      <span className="text-sm font-medium">{algaePercentage}%</span>
                      <span className="text-xs">100%</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            {/* Water Parameters */}
            <Card>
              <CardHeader>
                <CardTitle>Water Technology Parameters</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Energy Allocation to Water (%)</label>
                    <input 
                      type="range" 
                      min="1" 
                      max="20" 
                      value={energyAllocationToWater} 
                      onChange={(e) => setEnergyAllocationToWater(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">1%</span>
                      <span className="text-sm font-medium">{energyAllocationToWater}%</span>
                      <span className="text-xs">20%</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Desalination Allocation (%)</label>
                    <input 
                      type="range" 
                      min="0" 
                      max="100" 
                      value={desalinationAllocation} 
                      onChange={(e) => setDesalinationAllocation(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">0% (All AWG)</span>
                      <span className="text-sm font-medium">{desalinationAllocation}%</span>
                      <span className="text-xs">100% (All Desalination)</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Water Technologies Efficiency (%)</label>
                    <input 
                      type="range" 
                      min="50" 
                      max="150" 
                      value={waterTechsEfficiency} 
                      onChange={(e) => setWaterTechsEfficiency(parseInt(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">50%</span>
                      <span className="text-sm font-medium">{waterTechsEfficiency}%</span>
                      <span className="text-xs">150%</span>
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium mb-1">Water Value ($/m³)</label>
                    <input 
                      type="range" 
                      min="0.5" 
                      max="5" 
                      step="0.1"
                      value={waterValueUSD} 
                      onChange={(e) => setWaterValueUSD(parseFloat(e.target.value))}
                      className="w-full"
                    />
                    <div className="flex justify-between">
                      <span className="text-xs">$0.50</span>
                      <span className="text-sm font-medium">${waterValueUSD.toFixed(1)}</span>
                      <span className="text-xs">$5.00</span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
        
        {/* Energy Efficiency Tab */}
        <TabsContent value="efficiency">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <Card>
              <CardHeader>
                <CardTitle>Household Energy Savings</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64 mb-4">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={[
                          { name: 'Passive Solar', value: efficiencyResults.perHousehold.passiveSolarSavings },
                          { name: 'GSHP Heating', value: efficiencyResults.perHousehold.gshpHeatingSavings },
                          { name: 'GSHP Cooling', value: efficiencyResults.perHousehold.gshpCoolingSavings },
                          { name: 'HP Water Heater', value: efficiencyResults.perHousehold.hpwhSavings },
                          { name: 'HP Dryer', value: efficiencyResults.perHousehold.drySavings }
                        ]}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(1)}%`}
                        outerRadius={80}
                        fill="#8884d8"
                        dataKey="value"
                      >
                        {energySourceData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Pie>
                      <Tooltip formatter={(value) => [`${value.toFixed(0)} kWh`, 'Energy Savings']} />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
                
                <div className="grid grid-cols-2 gap-4 text-center">
                  <div>
                    <div className="text-2xl font-bold">{efficiencyResults.perHousehold.totalSavings.toFixed(0)} kWh</div>
                    <div className="text-sm text-gray-500">Annual Energy Savings</div>
                  </div>
                  <div>
                    <div className="text-2xl font-bold text-green-600">{efficiencyResults.perHousehold.percentageReduction.toFixed(0)}%</div>
                    <div className="text-sm text-gray-500">Reduction in Consumption</div>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Economic Analysis</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="p-4 bg-gray-100 rounded-lg mb-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <div className="text-sm text-gray-500">System Cost</div>
                      <div className="text-xl font-bold">${Math.round(efficiencyResults.perHousehold.systemCost).toLocaleString()}</div>
                      <div className="text-xs text-gray-500">Before incentives</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">After Incentives</div>
                      <div className="text-xl font-bold">${Math.round(efficiencyResults.perHousehold.netSystemCost).toLocaleString()}</div>
                      <div className="text-xs text-gray-500">Net cost</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Annual Savings</div>
                      <div className="text-xl font-bold">${efficiencyResults.perHousehold.annualCostSavings.toFixed(0)}</div>
                      <div className="text-xs text-gray-500">Utility bill reduction</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Payback Period</div>
                      <div className="text-xl font-bold">{efficiencyResults.perHousehold.paybackPeriod.toFixed(1)} years</div>
                      <div className="text-xs text-gray-500">With incentives</div>
                    </div>
                  </div>
                </div>
                
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={[
                      { rate: 5, payback: efficiencyResults.perHousehold.netSystemCost / (efficiencyResults.perHousehold.totalSavings * 0.05) },
                      { rate: 10, payback: efficiencyResults.perHousehold.netSystemCost / (efficiencyResults.perHousehold.totalSavings * 0.10) },
                      { rate: 15, payback: efficiencyResults.perHousehold.netSystemCost / (efficiencyResults.perHousehold.totalSavings * 0.15) },
                      { rate: 20, payback: efficiencyResults.perHousehold.netSystemCost / (efficiencyResults.perHousehold.totalSavings * 0.20) },
                      { rate: 25, payback: efficiencyResults.perHousehold.netSystemCost / (efficiencyResults.perHousehold.totalSavings * 0.25) }
                    ]}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="rate" label={{ value: 'Electricity Rate (¢/kWh)', position: 'insideBottom', offset: -5 }} />
                      <YAxis label={{ value: 'Payback Period (years)', angle: -90, position: 'insideLeft' }} />
                      <Tooltip formatter={(value) => [`${value.toFixed(1)} years`, 'Payback Period']} />
                      <Line type="monotone" dataKey="payback" stroke="#8884d8" />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Card>
              <CardHeader>
                <CardTitle>Environmental Impact</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-4 text-center mb-4">
                  <div>
                    <div className="text-2xl font-bold">{efficiencyResults.perHousehold.carbonReduction.toFixed(2)} tons</div>
                    <div className="text-sm text-gray-500">CO₂ Reduction per Household</div>
                  </div>
                  <div>
                    <div className="text-2xl font-bold text-green-600">{efficiencyResults.national.totalCarbonReduction.toFixed(1)}M tons</div>
                    <div className="text-sm text-gray-500">Total CO₂ Reduction @ {efficiencyAdoptionRate}% Adoption</div>
                  </div>
                </div>
                
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={[5, 10, 15, 20, 25, 30, 35, 40, 45, 50].map(rate => {
                      const homes = usData.households * (rate / 100);
                      const carbon = homes * efficiencyResults.perHousehold.carbonReduction / 1000000;
                      return {
                        rate,
                        carbon
                      };
                    })}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="rate" label={{ value: 'Adoption Rate (%)', position: 'insideBottom', offset: -5 }} />
                      <YAxis />
                      <Tooltip formatter={(value) => [`${value.toFixed(1)} million tons`, 'CO₂ Reduction']} />
                      <Area type="monotone" dataKey="carbon" fill="#82ca9d" stroke="#82ca9d" />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Grid & Electric Vehicle Impact</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-4 text-center mb-4">
                  <div>
                    <div className="text-2xl font-bold">{efficiencyResults.perHousehold.evsSupported.toFixed(2)}</div>
                    <div className="text-sm text-gray-500">EVs Supported per Household</div>
                  </div>
                  <div>
                    <div className="text-2xl font-bold text-green-600">{(efficiencyResults.national.totalEvsSupported / 1000000).toFixed(2)}M</div>
                    <div className="text-sm text-gray-500">Total EVs Supported @ {efficiencyAdoptionRate}% Adoption</div>
                  </div>
                </div>
                
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={[5, 10, 15, 20, 25, 30, 35, 40, 45, 50].map(rate => {
                      const homes = usData.households * (rate / 100);
                      const evs = homes * efficiencyResults.perHousehold.evsSupported / 1000000;
                      const energy = homes * efficiencyResults.perHousehold.totalSavings / 1000000000;
                      return {
                        rate,
                        evs,
                        energy
                      };
                    })}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="rate" label={{ value: 'Adoption Rate (%)', position: 'insideBottom', offset: -5 }} />
                      <YAxis />
                      <Tooltip formatter={(value, name) => {
                        switch (name) {
                          case 'evs': return [`${value.toFixed(2)} million`, 'EVs Supported'];
                          case 'energy': return [`${value.toFixed(2)} TWh`, 'Energy Saved'];
                          default: return [value, name];
                        }
                      }} />
                      <Area type="monotone" dataKey="evs" fill="#8884d8" stroke="#8884d8" />
                      <Area type="monotone" dataKey="energy" fill="#82ca9d" stroke="#82ca9d" />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
        
        {/* Renewable Energy Tab */}
        <TabsContent value="renewable">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <Card>
              <CardHeader>
                <CardTitle>Energy Generation by Source</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={energySourceData}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(1)}%`}
                        outerRadius={80}
                        fill="#8884d8"
                        dataKey="value"
                      >
                        {energySourceData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Pie>
                      <Tooltip formatter={(value) => [`${value.toFixed(2)} TWh/year`, 'Energy Production']} />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
                <div className="mt-2">
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <div className="text-sm font-medium">Waste-to-Energy:</div>
                      <div>{renewableResults.energyGeneration.wasteToEnergyTotal.toFixed(2)} TWh/year</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">SkySails Wind:</div>
                      <div>{renewableResults.energyGeneration.fromSkySails.toFixed(2)} TWh/year</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Biofuels:</div>
                      <div>{renewableResults.energyGeneration.biofuelsTotal.toFixed(2)} TWh/year</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Total:</div>
                      <div className="font-bold">{renewableResults.energyGeneration.total.toFixed(2)} TWh/year</div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Investment Breakdown</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={[
                      { name: 'Waste-to-Energy', value: renewableResults.economics.wasteToEnergyCost },
                      { name: 'SkySails', value: renewableResults.economics.skySailsCost },
                      { name: 'Battery Storage', value: renewableResults.economics.batteryCost },
                      { name: 'Algae Facilities', value: renewableResults.economics.algaeFacilitiesCost }
                    ]}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis />
                      <Tooltip formatter={(value) => [`$${value.toFixed(2)} billion`, 'Investment']} />
                      <Bar dataKey="value" fill="#8884d8">
                        {energySourceData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="mt-2">
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <div className="text-sm font-medium">Total Investment:</div>
                      <div className="font-bold">${renewableResults.economics.totalInvestment.toFixed(2)} billion</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Annual Revenue:</div>
                      <div>${renewableResults.economics.annualRevenue.toFixed(2)} billion</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Operating Cost:</div>
                      <div>${renewableResults.economics.operatingCost.toFixed(2)} billion</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Payback Period:</div>
                      <div>{renewableResults.economics.paybackPeriod.toFixed(1)} years</div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Card>
              <CardHeader>
                <CardTitle>Carbon Impact</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={[
                          { name: 'Biochar Sequestration', value: renewableResults.carbonImpact.sequestration },
                          { name: 'Avoided Emissions', value: renewableResults.carbonImpact.avoidance }
                        ]}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(1)}%`}
                        outerRadius={80}
                        fill="#8884d8"
                        dataKey="value"
                      >
                        {[0, 1].map((entry) => (
                          <Cell key={`cell-${entry}`} fill={COLORS[entry % COLORS.length]} />
                        ))}
                      </Pie>
                      <Tooltip formatter={(value) => [`${value.toFixed(2)} million tons CO₂/year`, 'Carbon Impact']} />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
                <div className="mt-2">
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <div className="text-sm font-medium">Carbon Sequestered:</div>
                      <div>{renewableResults.carbonImpact.sequestration.toFixed(2)} million tons CO₂/year</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Emissions Avoided:</div>
                      <div>{renewableResults.carbonImpact.avoidance.toFixed(2)} million tons CO₂/year</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Total Impact:</div>
                      <div className="font-bold">{renewableResults.carbonImpact.total.toFixed(2)} million tons CO₂/year</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">% of US Emissions:</div>
                      <div>{renewableResults.carbonImpact.percentOfUSEmissions.toFixed(2)}%</div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Waste Utilization</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={[
                      { name: 'Food Waste', value: renewableResults.wasteUtilization.foodWaste },
                      { name: 'Agricultural', value: renewableResults.wasteUtilization.agriculturalWaste },
                      { name: 'Forest', value: renewableResults.wasteUtilization.forestWaste },
                      { name: 'MSW', value: renewableResults.wasteUtilization.msw }
                    ]}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis />
                      <Tooltip formatter={(value) => [`${value.toFixed(2)} million tons`, 'Waste Utilized']} />
                      <Bar dataKey="value" fill="#8884d8">
                        {[0, 1, 2, 3].map((index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Pie>
                      <Tooltip formatter={(value) => [`${value.toFixed(2)} million tons CO₂/year`, 'Carbon Reduction']} />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
                <div className="mt-2">
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <div className="text-sm font-medium">Fleet Retrofit:</div>
                      <div>{transportationResults.carbonReduction.fleet.toFixed(2)} million tons CO₂</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Carbon Capture:</div>
                      <div>{transportationResults.carbonReduction.ccu.toFixed(2)} million tons CO₂</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Biofuels:</div>
                      <div>{(transportationResults.carbonReduction.hemp + transportationResults.carbonReduction.algae).toFixed(2)} million tons CO₂</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Total Impact:</div>
                      <div className="font-bold">{transportationResults.carbonReduction.total.toFixed(2)} million tons CO₂</div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Economic Benefits</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="p-4 bg-gray-100 rounded-lg mb-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <div className="text-sm text-gray-500">Implementation Cost</div>
                      <div className="text-xl font-bold">${transportationResults.economics.cost.toFixed(2)}B</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Annual Benefits</div>
                      <div className="text-xl font-bold">${transportationResults.economics.revenue.toFixed(2)}B</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Net Annual Benefit</div>
                      <div className="text-xl font-bold">${transportationResults.economics.netBenefit.toFixed(2)}B</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Payback Period</div>
                      <div className="text-xl font-bold">{transportationResults.economics.paybackPeriod.toFixed(1)} years</div>
                    </div>
                  </div>
                </div>
                
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={[
                      { name: 'Algae Revenue', value: (algaePercentage / 25) * 5 * 4 },
                      { name: 'Hemp Revenue', value: (hempUtilization / 50) * 0.09 * 2 },
                      { name: 'Carbon Credits', value: transportationResults.carbonReduction.total * carbonCreditPrice / 1000 },
                      { name: 'Oil Savings', value: transportationResults.oilImpact.reduction * 365 * 70 / 1000 }
                    ]}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis />
                      <Tooltip formatter={(value) => [`${value.toFixed(2)} billion`, 'Annual Value']} />
                      <Bar dataKey="value" fill="#82ca9d" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Card>
              <CardHeader>
                <CardTitle>Oil Import Reduction</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="p-4 bg-green-50 rounded-lg text-center">
                    <div className="text-sm text-gray-600">Oil Import Reduction</div>
                    <div className="text-3xl font-bold">{transportationResults.oilImpact.reduction.toFixed(2)} million barrels/day</div>
                    <div className="text-sm text-gray-500">
                      {transportationResults.oilImpact.percent.toFixed(1)}% of current US imports
                    </div>
                  </div>
                  
                  <div className="p-4 bg-blue-50 rounded-lg text-center">
                    <div className="text-sm text-gray-600">Annual Oil Savings</div>
                    <div className="text-3xl font-bold">${(transportationResults.oilImpact.reduction * 365 * 70 / 1000).toFixed(2)} billion</div>
                    <div className="text-sm text-gray-500">
                      At $70 per barrel
                    </div>
                  </div>
                  
                  <div className="p-4 bg-purple-50 rounded-lg text-center">
                    <div className="text-sm text-gray-600">Alternative Fuel Production</div>
                    <div className="text-3xl font-bold">{transportationResults.energy.total.toFixed(2)} TWh</div>
                    <div className="text-sm text-gray-500">
                      From algae, hemp, and carbon capture
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Job Creation</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={[
                      { name: 'Algae Production', value: (algaePercentage / 25) * 60000 * 4 },
                      { name: 'Hemp Processing', value: (hempUtilization / 50) * 895 * 2 },
                      { name: 'Vehicle Retrofits', value: (retrofitPercentage / 50) * 50000 }
                    ]}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis />
                      <Tooltip formatter={(value) => [`${Math.round(value).toLocaleString()} jobs`, 'Employment Created']} />
                      <Bar dataKey="value" fill="#8884d8" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="mt-4 text-center">
                  <div className="text-sm text-gray-600">Total Jobs Created</div>
                  <div className="text-3xl font-bold">{Math.round(transportationResults.jobs).toLocaleString()}</div>
                  <div className="text-sm text-gray-500">
                    Primarily in rural and manufacturing communities
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
        
        {/* Water Systems Tab */}
        <TabsContent value="water">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <Card>
              <CardHeader>
                <CardTitle>Water Production by Technology</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={waterProductionData}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(1)}%`}
                        outerRadius={80}
                        fill="#8884d8"
                        dataKey="value"
                      >
                        {waterProductionData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                      </Pie>
                      <Tooltip formatter={(value) => [`${value.toFixed(2)} million m³/year`, 'Water Production']} />
                    </PieChart>
                  </ResponsiveContainer>
                </div>
                <div className="mt-2">
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <div className="text-sm font-medium">Solar Desalination:</div>
                      <div>{waterResults.production.desalination.toFixed(2)} million m³/year</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Atmospheric Water:</div>
                      <div>{waterResults.production.awg.toFixed(2)} million m³/year</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Total Water:</div>
                      <div className="font-bold">{waterResults.production.total.toFixed(2)} million m³/year</div>
                    </div>
                    <div>
                      <div className="text-sm font-medium">Energy Used:</div>
                      <div>{waterResults.energy.allocated.toFixed(2)} TWh/year</div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Water Impact</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-4 text-center mb-4">
                  <div className="p-3 bg-blue-50 rounded">
                    <div className="text-sm text-gray-600">Population Served</div>
                    <div className="text-xl font-bold">{waterResults.impact.populationServed.toFixed(2)}M</div>
                    <div className="text-xs text-gray-500">With basic water needs</div>
                  </div>
                  
                  <div className="p-3 bg-green-50 rounded">
                    <div className="text-sm text-gray-600">Agricultural Land</div>
                    <div className="text-xl font-bold">{waterResults.impact.irrigatedLand.toFixed(2)}M hectares</div>
                    <div className="text-xs text-gray-500">Irrigated farmland</div>
                  </div>
                  
                  <div className="p-3 bg-yellow-50 rounded">
                    <div className="text-sm text-gray-600">Food Production</div>
                    <div className="text-xl font-bold">{waterResults.impact.foodProduction.toFixed(2)}M tons</div>
                    <div className="text-xs text-gray-500">Annual yield</div>
                  </div>
                  
                  <div className="p-3 bg-purple-50 rounded">
                    <div className="text-sm text-gray-600">Public Supply</div>
                    <div className="text-xl font-bold">{waterResults.impact.percentOfPublicSupply.toFixed(2)}%</div>
                    <div className="text-xs text-gray-500">Of US public water</div>
                  </div>
                </div>
                
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={[
                      { name: 'Current', value: usData.publicWaterSupply },
                      { name: 'With System', value: usData.publicWaterSupply + waterResults.production.total / 1000 }
                    ]}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="name" />
                      <YAxis domain={[0, 'dataMax + 5']} />
                      <Tooltip formatter={(value) => [`${value.toFixed(2)} billion m³/year`, 'Water Supply']} />
                      <Bar dataKey="value" fill="#0088FE" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Card>
              <CardHeader>
                <CardTitle>Economic Analysis</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="p-4 bg-gray-100 rounded-lg mb-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <div className="text-sm text-gray-500">System Cost</div>
                      <div className="text-xl font-bold">${waterResults.economics.totalInvestment.toFixed(2)}B</div>
                      <div className="text-xs text-gray-500">Capital investment</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Water Value</div>
                      <div className="text-xl font-bold">${waterResults.economics.waterValue.toFixed(2)}B</div>
                      <div className="text-xs text-gray-500">Annual production value</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Operating Cost</div>
                      <div className="text-xl font-bold">${waterResults.economics.operatingCost.toFixed(2)}B</div>
                      <div className="text-xs text-gray-500">Annual expenses</div>
                    </div>
                    <div>
                      <div className="text-sm text-gray-500">Payback Period</div>
                      <div className="text-xl font-bold">{waterResults.economics.paybackPeriod.toFixed(1)} years</div>
                      <div className="text-xs text-gray-500">Return on investment</div>
                    </div>
                  </div>
                </div>
                
                <div className="h-48">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={[0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0].map(rate => {
                      return {
                        rate: rate,
                        payback: waterResults.economics.totalInvestment / ((waterResults.production.total * rate / 1000000) - waterResults.economics.operatingCost)
                      };
                    })}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="rate" label={{ value: 'Water Value ($/m³)', position: 'insideBottom', offset: -5 }} />
                      <YAxis domain={[0, 15]} label={{ value: 'Payback (years)', angle: -90, position: 'insideLeft' }} />
                      <Tooltip formatter={(value) => [`${value.toFixed(1)} years`, 'Payback Period']} />
                      <Line type="monotone" dataKey="payback" stroke="#8884d8" />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Water-Energy-Food Nexus</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div className="p-3 bg-blue-50 rounded">
                    <div className="text-sm font-medium mb-1">Energy-Water Relationship</div>
                    <div className="flex justify-between">
                      <span>{(waterResults.energy.allocated / renewableResults.energyGeneration.total * 100).toFixed(1)}% of renewable energy</span>
                      <span>→</span>
                      <span>{waterResults.production.total.toFixed(1)}M m³ water</span>
                    </div>
                    <div className="text-xs text-gray-600 mt-1">
                      Energy intensity: {((waterResults.energy.forDesalination * 1000 / waterResults.production.desalination) * desalinationAllocation/100 + (waterResults.energy.forAWG * 1000 / waterResults.production.awg) * (100-desalinationAllocation)/100).toFixed(2)} kWh/m³ (weighted average)
                    </div>
                  </div>
                  
                  <div className="p-3 bg-green-50 rounded">
                    <div className="text-sm font-medium mb-1">Water-Food Relationship</div>
                    <div className="flex justify-between">
                      <span>{(waterResults.production.total * agricultureAllocation/100).toFixed(1)}M m³ water</span>
                      <span>→</span>
                      <span>{waterResults.impact.foodProduction.toFixed(1)}M tons food</span>
                    </div>
                    <div className="text-xs text-gray-600 mt-1">
                      Water efficiency: {(waterResults.impact.foodProduction / (waterResults.production.total * agricultureAllocation/100)).toFixed(2)} tons food per 1000 m³ water
                    </div>
                  </div>
                  
                  <div className="p-3 bg-yellow-50 rounded">
                    <div className="text-sm font-medium mb-1">Energy-Food Relationship</div>
                    <div className="flex justify-between">
                      <span>{(waterResults.energy.allocated * renewableResults.energyGeneration.fromAlgae / renewableResults.energyGeneration.total).toFixed(2)} TWh energy</span>
                      <span>→</span>
                      <span>{(renewableResults.production.algae / 10).toFixed(2)}M tons algae</span>
                    </div>
                    <div className="text-xs text-gray-600 mt-1">
                      Energy yield: {(renewableResults.energyGeneration.fromAlgae / (renewableResults.production.algae / 10)).toFixed(2)} MWh per ton biomass
                    </div>
                  </div>
                  
                  <div className="p-3 bg-purple-50 rounded">
                    <div className="text-sm font-medium mb-1">Carbon Impact</div>
                    <div className="flex justify-between">
                      <span>Water Systems</span>
                      <span>→</span>
                      <span>{waterResults.carbon.reduction.toFixed(2)}M tons CO₂ saved</span>
                    </div>
                    <div className="text-xs text-gray-600 mt-1">
                      Carbon efficiency: {(waterResults.carbon.reduction / waterResults.production.total).toFixed(2)} kg CO₂ saved per m³ water
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
        
        {/* Phased Implementation Tab */}
        <TabsContent value="phased">
          <div className="grid grid-cols-1 gap-6 mb-6">
            <Card>
              <CardHeader>
                <CardTitle>Phased Implementation Timeline</CardTitle>
                <CardDescription>{efficiencyFirst ? "Efficiency-First Approach" : "Generation-First Approach"}</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="h-80">
                  <ResponsiveContainer width="100%" height="100%">
                    <ComposedChart data={phasedPlan}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="year" />
                      <YAxis yAxisId="left" label={{ value: 'Carbon Reduction (MT)', angle: -90, position: 'insideLeft' }} />
                      <YAxis yAxisId="right" orientation="right" label={{ value: 'Investment ($B)', angle: 90, position: 'insideRight' }} />
                      <Tooltip formatter={(value, name) => {
                        if (name === 'carbonReduction') return [`${value.toFixed(2)} million tons`, 'Carbon Reduction'];
                        if (name === 'investment') return [`${value.toFixed(2)} billion`, 'Cumulative Investment'];
                        return [value, name];
                      }} />
                      <Legend />
                      <Area type="monotone" dataKey="totals.carbonReduction" name="Carbon Reduction" yAxisId="left" fill="#82ca9d" stroke="#82ca9d" />
                      <Line type="monotone" dataKey="totals.investment" name="Cumulative Investment" yAxisId="right" stroke="#8884d8" />
                    </ComposedChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <Card>
              <CardHeader>
                <CardTitle>Energy Impact by Phase</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={phasedEnergyData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="year" />
                      <YAxis />
                      <Tooltip formatter={(value) => [`${value.toFixed(2)} TWh`, 'Energy']} />
                      <Legend />
                      <Area type="monotone" dataKey="efficiencySavings" name="Efficiency Savings" stackId="1" fill="#8884d8" stroke="#8884d8" />
                      <Area type="monotone" dataKey="energyGeneration" name="Renewable Generation" stackId="2" fill="#82ca9d" stroke="#82ca9d" />
                      <Line type="monotone" dataKey="netEnergyImpact" name="Net Energy Impact" stroke="#ff7300" />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <CardTitle>Carbon Reduction by Phase</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={phasedCarbonData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="year" />
                      <YAxis />
                      <Tooltip formatter={(value) => [`${value.toFixed(2)} million tons`, 'Carbon Reduction']} />
                      <Legend />
                      <Area type="monotone" dataKey="efficiency" name="Efficiency" stackId="1" fill="#8884d8" stroke="#8884d8" />
                      <Area type="monotone" dataKey="energy" name="Renewable Energy" stackId="1" fill="#82ca9d" stroke="#82ca9d" />
                      <Area type="monotone" dataKey="transportation" name="Transportation" stackId="1" fill="#ffc658" stroke="#ffc658" />
                      <Area type="monotone" dataKey="water" name="Water Systems" stackId="1" fill="#ff8042" stroke="#ff8042" />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>
          </div>
          
          <Card>
            <CardHeader>
              <CardTitle>Implementation Plan Detail</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="overflow-x-auto">
                <table className="min-w-full">
                  <thead>
                    <tr>
                      <th className="text-left">Phase</th>
                      <th className="text-right">Year</th>
                      <th className="text-right">Energy Savings (TWh)</th>
                      <th className="text-right">Renewable Gen (TWh)</th>
                      <th className="text-right">Carbon Reduction (MT)</th>
                      <th className="text-right">% of US Emissions</th>
                      <th className="text-right">Water Prod (M m³)</th>
                      <th className="text-right">Investment ($B)</th>
                      <th className="text-right">Jobs Created</th>
                    </tr>
                  </thead>
                  <tbody>
                    {phasedPlan.map((phase) => (
                      <tr key={phase.phase} className={phase.phase === phasedPlan.length ? "font-bold" : ""}>
                        <td>{phase.phase}</td>
                        <td className="text-right">{phase.year}</td>
                        <td className="text-right">{phase.efficiency.savings.toFixed(2)}</td>
                        <td className="text-right">{phase.energy.generation.toFixed(2)}</td>
                        <td className="text-right">{phase.totals.carbonReduction.toFixed(2)}</td>
                        <td className="text-right">{phase.totals.percentOfUSEmissions.toFixed(2)}%</td>
                        <td className="text-right">{phase.water.production.toFixed(2)}</td>
                        <td className="text-right">${phase.totals.investment.toFixed(2)}</td>
                        <td className="text-right">{Math.round(phase.totals.jobs).toLocaleString()}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>
    </div>
  );
};

export default IntegratedEnergyWaterCalculator;[index % COLORS.length]} />
                        ))}
                      </Bar>
                    </BarChart>
                  </ResponsiveContainer>
                </div>
                <div className="mt-2">
                  <div className="text-lg font-medium">Total Waste Utilized:</div>
                  <div className="text-xl font-bold">{renewableResults.wasteUtilization.total.toFixed(2)} million tons/year</div>
                </div>
              </CardContent>
            </Card>
          </div>
        </TabsContent>
        
        {/* Transportation Tab */}
        <TabsContent value="transport">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <Card>
              <CardHeader>
                <CardTitle>Carbon Reduction Sources</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="h-64">
                  <ResponsiveContainer width="100%" height="100%">
                    <PieChart>
                      <Pie
                        data={[
                          { name: 'Fleet Retrofit', value: transportationResults.carbonReduction.fleet },
                          { name: 'Carbon Capture', value: transportationResults.carbonReduction.ccu },
                          { name: 'Hemp Biofuel', value: transportationResults.carbonReduction.hemp },
                          { name: 'Algae Biofuel', value: transportationResults.carbonReduction.algae }
                        ]}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(1)}%`}
                        outerRadius={80}
                        fill="#8884d8"
                        dataKey="value"
                      >
                        {[0, 1, 2, 3].map((index) => (
                          <Cell key={`cell-${index}`} fill={COLORS
